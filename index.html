<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uma Musume - S√©lecteur d'√©quipe (v3)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg,#fffafc,#ffe6f0); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card-hover:hover { transform: translateY(-4px); transition: transform .18s ease; }
    .modal-backdrop { background: rgba(0,0,0,0.5); }
    .big-score { font-size: 3rem; line-height: 1; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="flex items-center justify-between p-4 bg-white/80 border-b border-pink-200">
    <div class="flex items-center gap-4">
      <div class="text-2xl font-bold text-pink-600">üêé Uma Selector</div>
      <div id="teamBadge" class="hidden text-sm text-gray-700">√âquipe: <span id="teamLabel" class="font-semibold"></span></div>
    </div>

    <div class="flex items-center gap-3">
      <div id="totalContainer" class="flex items-baseline gap-2 mr-4">
        <div class="text-sm text-gray-600">Total</div>
        <div id="totalScore" class="big-score text-green-600 font-bold">0</div>
        <div class="text-sm text-gray-600">/ <span id="maxScore">30</span></div>
      </div>
      <button id="changeTeamBtn" class="px-3 py-1 rounded bg-pink-100 text-pink-700 hidden">Changer d'√©quipe</button>
      <button id="adminModeBtn" class="px-3 py-1 rounded bg-gray-100 text-gray-800">Mode admin</button>
    </div>
  </header>

  <!-- MAIN (hidden tant que pas connect√©) -->
  <main id="appContent" class="flex-1 hidden">
    <aside class="w-1/3 p-4 overflow-auto border-r border-pink-200 bg-white/70">
      <h2 class="text-lg font-semibold text-pink-600 mb-3">Liste des Uma</h2>
      <input id="searchInput" type="search" placeholder="Rechercher..." class="w-full p-2 border border-pink-200 rounded mb-3" />
      <div id="umaList" class="grid grid-cols-2 gap-3"></div>
    </aside>

    <section class="flex-1 p-6 overflow-auto">
      <h2 class="text-lg font-semibold text-pink-600 mb-3">S√©lection</h2>
      <div id="selectedArea" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <!-- FULLSCREEN LOGIN (shown until authenticated) -->
  <div id="loginScreen" class="fixed inset-0 flex items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-xl font-semibold mb-4">Connectez-vous</h3>

      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Se connecter en tant qu'√©quipe</label>
        <select id="teamSelect" class="w-full p-2 border rounded mb-2">
          <!-- Options loaded from Firebase in Part 2 -->
        </select>
        <input id="teamPwdField" type="password" placeholder="Mot de passe √©quipe" class="w-full p-2 border rounded" />
        <div class="flex justify-end gap-2 mt-2">
          <button id="teamLoginBtn" class="px-3 py-1 bg-pink-500 text-white rounded">Connexion √©quipe</button>
        </div>
        <p id="teamLoginError" class="text-red-600 text-sm mt-2 hidden"></p>
      </div>

      <hr class="my-3" />

      <div>
        <label class="block text-sm text-gray-600 mb-1">Connexion admin</label>
        <input id="adminPwdField" type="password" placeholder="Mot de passe admin" class="w-full p-2 border rounded mb-2" />
        <div class="flex justify-end gap-2">
          <button id="adminLoginBtn" class="px-3 py-1 bg-gray-800 text-white rounded">Connexion admin</button>
        </div>
        <p id="adminLoginError" class="text-red-600 text-sm mt-2 hidden"></p>
      </div>
    </div>
  </div>

  <!-- MODAL: custom name -->
  <div id="nameModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-40">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-lg font-semibold mb-2">Nom personnalis√©</h3>
      <div class="text-sm text-gray-700 mb-2">Pour : <span id="nameForUma"></span></div>
      <input id="customNameField" type="text" class="w-full p-2 border rounded" maxlength="30" />
      <div class="flex justify-end gap-2 mt-4">
        <button id="customNameCancel" class="px-3 py-1 bg-gray-100 rounded">Annuler</button>
        <button id="customNameOk" class="px-3 py-1 bg-pink-500 text-white rounded">Ajouter</button>
      </div>
    </div>
  </div>

  <!-- MODAL: confirm deletion -->
  <div id="deleteModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-40">
    <div class="bg-white rounded-lg shadow-xl w-80 p-6">
      <h3 class="text-lg font-semibold mb-2">Confirmer</h3>
      <p id="deleteText" class="text-sm text-gray-700 mb-4"></p>
      <div class="flex justify-end gap-2">
        <button id="deleteCancel" class="px-3 py-1 bg-gray-100 rounded">Annuler</button>
        <button id="deleteOk" class="px-3 py-1 bg-red-500 text-white rounded">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- MODAL: admin panel (accessed from top button) -->
  <div id="adminModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-4/5 p-6 max-h-[85vh] overflow-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Panneau administrateur</h3>
        <div class="flex gap-2">
          <button id="adminLogoutBtn" class="px-3 py-1 bg-gray-100 rounded">D√©connexion Admin</button>
          <button id="adminCloseBtn" class="px-3 py-1 bg-gray-100 rounded">Fermer</button>
        </div>
      </div>

      <!-- Edit max score -->
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Score maximum</label>
        <input id="adminMax" type="number" min="1" class="p-2 border rounded w-32" />
        <button id="saveMaxBtn" class="ml-3 px-3 py-1 bg-green-500 text-white rounded">Sauvegarder</button>
      </div>

      <!-- Manage uma scores -->
      <div class="mb-6">
        <h4 class="font-semibold mb-2">Modifier scores Uma</h4>
        <div id="adminUmaEditList" class="grid grid-cols-1 gap-2 max-h-60 overflow-auto"></div>
      </div>

      <!-- Manage teams -->
      <div>
        <h4 class="font-semibold mb-2">G√©rer les √©quipes</h4>
        <div class="mb-2 flex gap-2">
          <input id="newTeamName" placeholder="Nom de l'√©quipe" class="p-2 border rounded" />
          <input id="newTeamPwd" placeholder="Mot de passe" class="p-2 border rounded" />
          <button id="addTeamBtn" class="px-3 py-1 bg-blue-500 text-white rounded">Ajouter √©quipe</button>
        </div>
        <div id="adminTeamsList" class="grid grid-cols-1 gap-2 max-h-48 overflow-auto"></div>
      </div>
    </div>
  </div>

  <!-- SCRIPT: Partie 1 (UI + non-Firebase logic) -->
  <script type="module">
    // -------------------------
    // Variables d'√©tat (front)
    // -------------------------
    let umas = [
      { id: "special-week", name: "Special Week", img: "https://static.wikia.nocookie.net/umamusume/images/8/8e/Special_Week_Portrait.png", score: 5 },
      { id: "silence-suzuka", name: "Silence Suzuka", img: "https://static.wikia.nocookie.net/umamusume/images/a/a4/Silence_Suzuka_Portrait.png", score: 4 },
      { id: "tokai-teio", name: "Tokai Teio", img: "https://static.wikia.nocookie.net/umamusume/images/1/12/Tokai_Teio_Portrait.png", score: 5 },
      { id: "mejiro-mcqueen", name: "Mejiro McQueen", img: "https://static.wikia.nocookie.net/umamusume/images/7/7f/Mejiro_McQueen_Portrait.png", score: 3 }
      // ... on merge les donn√©es r√©elles depuis Firebase dans la Partie 2
    ];

    let teamsList = []; // liste des noms d'√©quipes (sera remplie depuis Firebase)
    let authMap = {};   // mapping name->password (loaded from firebase in part2)
    let currentTeam = null;
    let isAdmin = false;
    let selectedUmas = []; // {id,name,img,score,customName}
    let currentTotal = 0;
    let maxScore = 30;

    // DOM refs
    const loginScreen = document.getElementById('loginScreen');
    const appContent = document.getElementById('appContent');
    const teamSelect = document.getElementById('teamSelect');
    const teamPwdField = document.getElementById('teamPwdField');
    const teamLoginBtn = document.getElementById('teamLoginBtn');
    const teamLoginError = document.getElementById('teamLoginError');

    const adminPwdField = document.getElementById('adminPwdField');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminLoginError = document.getElementById('adminLoginError');

    const nameModal = document.getElementById('nameModal');
    const nameForUma = document.getElementById('nameForUma');
    const customNameField = document.getElementById('customNameField');
    const customNameOk = document.getElementById('customNameOk');
    const customNameCancel = document.getElementById('customNameCancel');

    const deleteModal = document.getElementById('deleteModal');
    const deleteText = document.getElementById('deleteText');
    const deleteOk = document.getElementById('deleteOk');
    const deleteCancel = document.getElementById('deleteCancel');

    const umaListElem = document.getElementById('umaList');
    const selectedArea = document.getElementById('selectedArea');
    const searchInput = document.getElementById('searchInput');

    const totalScoreElem = document.getElementById('totalScore');
    const maxScoreElem = document.getElementById('maxScore');
    const teamLabel = document.getElementById('teamLabel');
    const teamBadge = document.getElementById('teamBadge');

    const adminModeBtn = document.getElementById('adminModeBtn');
    const adminModal = document.getElementById('adminModal');
    const adminCloseBtn = document.getElementById('adminCloseBtn');
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    const adminMax = document.getElementById('adminMax');
    const adminUmaEditList = document.getElementById('adminUmaEditList');
    const adminTeamsList = document.getElementById('adminTeamsList');
    const newTeamName = document.getElementById('newTeamName');
    const newTeamPwd = document.getElementById('newTeamPwd');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const saveMaxBtn = document.getElementById('saveMaxBtn');

    const changeTeamBtn = document.getElementById('changeTeamBtn');

    // helper open/close modals
    function open(el){ el.classList.remove('hidden'); }
    function close(el){ el.classList.add('hidden'); }

    // -------------------------
    // RENDER UI: list UMA left
    // -------------------------
    function renderUmaList(filter='') {
      umaListElem.innerHTML = '';
      const q = (filter||'').trim().toLowerCase();
      umas.forEach(u => {
        if (!q || u.name.toLowerCase().includes(q)) {
          const div = document.createElement('div');
          div.className = 'bg-white p-3 rounded-lg shadow-sm flex flex-col items-center card-hover cursor-pointer';
          div.innerHTML = `
            <img src="${u.img}" alt="${u.name}" class="w-20 h-20 object-cover rounded-full mb-2" />
            <div class="text-sm font-medium text-center">${u.name}</div>
            <div class="text-xs text-gray-500 mt-1">Score: <span data-uma="${u.id}">${u.score}</span></div>
          `;
          div.addEventListener('click', () => openNamePrompt(u));
          umaListElem.appendChild(div);
        }
      });
    }

    searchInput.addEventListener('input', ()=> renderUmaList(searchInput.value));

    // -------------------------
    // Add UMA flow (modal for custom name)
    // -------------------------
    let pendingUma = null;
    function openNamePrompt(uma){
      pendingUma = uma;
      nameForUma.textContent = uma.name;
      customNameField.value = '';
      open(nameModal);
      setTimeout(()=> customNameField.focus(),100);
    }

    customNameCancel.addEventListener('click', ()=> { pendingUma = null; close(nameModal); });
    customNameOk.addEventListener('click', ()=>{
      const val = customNameField.value.trim();
      if (!val) {
        customNameField.classList.add('border-red-500');
        setTimeout(()=> customNameField.classList.remove('border-red-500'),600);
        return;
      }
      const picked = { id: pendingUma.id, name: pendingUma.name, img: pendingUma.img, score: pendingUma.score, customName: val, addedAt: Date.now() };
      selectedUmas.push(picked);
      currentTotal += picked.score;
      persistTeamLocal(); // local persistence for convenience (cloud save in part2)
      renderSelected();
      // saveData() will be called in Part 2 (cloud)
      close(nameModal);
      pendingUma = null;
    });

    // -------------------------
    // RENDER selected right
    // -------------------------
    function renderSelected(){
      selectedArea.innerHTML = '';
      selectedUmas.forEach((u, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white p-3 rounded-2xl shadow flex flex-col items-center relative';
        card.innerHTML = `
          <button class="absolute top-2 right-2 text-red-500 text-xl remove-btn">&times;</button>
          <img src="${u.img}" class="w-24 h-24 object-cover rounded-full mb-2" />
          <div class="text-sm font-semibold text-pink-600">${u.name}</div>
          <div class="text-xs italic text-gray-600 mb-1">${u.customName}</div>
          <div class="text-xs text-gray-400">Score: ${u.score}</div>
        `;
        card.querySelector('.remove-btn').addEventListener('click', ()=> {
          openDeleteConfirm(`Supprimer ${u.customName} (${u.name}) ?`, idx);
        });
        selectedArea.appendChild(card);
      });
      updateTotalDisplay();
    }

    // -------------------------
    // Delete confirm modal
    // -------------------------
    let pendingDeleteIdx = null;
    function openDeleteConfirm(text, idx){
      deleteText.textContent = text;
      pendingDeleteIdx = idx;
      open(deleteModal);
    }
    deleteCancel.addEventListener('click', ()=> { pendingDeleteIdx = null; close(deleteModal); });
    deleteOk.addEventListener('click', ()=> {
      if (pendingDeleteIdx !== null) {
        const removed = selectedUmas.splice(pendingDeleteIdx,1)[0];
        currentTotal -= removed.score;
        persistTeamLocal();
        renderSelected();
        // saveData() will be called in Part 2
      }
      pendingDeleteIdx = null;
      close(deleteModal);
    });

    // -------------------------
    // Total display
    // -------------------------
    function updateTotalDisplay(){
      totalScoreElem.textContent = currentTotal;
      maxScoreElem.textContent = maxScore;
      teamLabel.textContent = currentTeam || '';
      if (currentTotal <= maxScore) {
        totalScoreElem.classList.remove('text-red-600'); totalScoreElem.classList.add('text-green-600');
      } else {
        totalScoreElem.classList.remove('text-green-600'); totalScoreElem.classList.add('text-red-600');
      }
    }

    // -------------------------
    // LOGIN flow (team & admin)
    // -------------------------
    // teamLoginBtn -> validate teamSelect & password against authMap (loaded in part2)
    teamLoginBtn.addEventListener('click', ()=>{
      const chosen = teamSelect.value;
      const pwd = teamPwdField.value || '';
      teamLoginError.classList.add('hidden');
      if (!chosen) { teamLoginError.textContent = 'S√©lectionne une √©quipe'; teamLoginError.classList.remove('hidden'); return; }
      // authentication will be performed in Part 2 using authMap from firebase
      // here we just call a placeholder that will be replaced by the firebase-enabled implementation
      if (typeof window.__authClientValidate === 'function') {
        window.__authClientValidate(chosen, pwd).then(ok => {
          if (ok) {
            currentTeam = chosen; isAdmin = false;
            afterLogin();
          } else {
            teamLoginError.textContent = 'Mot de passe incorrect'; teamLoginError.classList.remove('hidden');
          }
        });
      } else {
        // fallback for testing without firebase: accept if pwd == "toto"
        if (pwd === 'toto') { currentTeam = chosen; isAdmin = false; afterLogin(); }
        else { teamLoginError.textContent = 'Mot de passe incorrect (sans Firebase)'; teamLoginError.classList.remove('hidden'); }
      }
    });

    // admin login (separate modal triggered by top button)
    adminModeBtn.addEventListener('click', () => {
      // show admin password area in the login screen for simplicity (we use same loginScreen modal)
      open(loginScreen);
    });
    adminLoginBtn.addEventListener('click', ()=> {
      const pwd = adminPwdField.value || '';
      adminLoginError.classList.add('hidden');
      if (typeof window.__adminValidate === 'function') {
        window.__adminValidate(pwd).then(result => {
          if (result.ok) {
            currentTeam = result.team; isAdmin = true;
            afterLogin();
          } else {
            adminLoginError.textContent = 'Mot de passe admin incorrect'; adminLoginError.classList.remove('hidden');
          }
        });
      } else {
        // fallback for testing: pwd === 'toto3'
        if (pwd === 'toto3') { currentTeam = 'Equipe 1'; isAdmin = true; afterLogin(); }
        else { adminLoginError.textContent = 'Mot de passe admin incorrect (sans Firebase)'; adminLoginError.classList.remove('hidden'); }
      }
    });

    changeTeamBtn.addEventListener('click', ()=> {
      // show login modal to allow switching teams
      open(loginScreen);
    });

    function afterLogin(){
      // hide login, show app, load team data (load from firebase in Part2)
      close(loginScreen);
      appContent.classList.remove('hidden');
      teamBadge.classList.remove('hidden');
      changeTeamBtn.classList.remove('hidden');
      if (isAdmin) {
        adminModeBtn.classList.add('bg-yellow-100'); // visual hint
        open(adminModal); // admin sees admin panel automatically
      }
      // persist team in localStorage for convenience
      localStorage.setItem('umaSession', JSON.stringify({ team: currentTeam, isAdmin }));
      // load team data from cloud in Part 2 (function __loadRemoteForTeam will be provided there)
      if (typeof window.__loadRemoteForTeam === 'function') window.__loadRemoteForTeam(currentTeam);
    }

    // -------------------------
    // ADMIN PANEL interactions (non-cloud actions here; cloud in Part2)
    // -------------------------
    adminCloseBtn.addEventListener('click', ()=> close(adminModal));
    adminLogoutBtn.addEventListener('click', ()=> {
      isAdmin = false; localStorage.removeItem('umaSession'); close(adminModal); location.reload();
    });

    // Render admin uma list
    function renderAdminUmaEdit(){
      adminUmaEditList.innerHTML = '';
      umas.forEach(u => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
        row.innerHTML = `
          <div>
            <div class="text-sm font-medium">${u.name}</div>
            <div class="text-xs text-gray-500">${u.id}</div>
          </div>
          <div class="flex items-center gap-2">
            <input type="number" min="0" value="${u.score}" data-uma="${u.id}" class="w-20 p-1 border rounded" />
          </div>
        `;
        adminUmaEditList.appendChild(row);
      });
    }

    // Render admin teams list (placeholder; will be filled from Firebase in Part2)
    function renderAdminTeams(){
      adminTeamsList.innerHTML = '';
      teamsList.forEach(t => {
        const el = document.createElement('div');
        el.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
        el.innerHTML = `
          <div class="text-sm font-medium">${t}</div>
          <div class="flex gap-2">
            <button class="edit-team px-2 py-1 bg-yellow-100 rounded" data-team="${t}">√âditer</button>
            <button class="delete-team px-2 py-1 bg-red-100 rounded" data-team="${t}">Suppr</button>
          </div>
        `;
        adminTeamsList.appendChild(el);
      });
      // attach handlers (will call cloud functions in Part2)
      adminTeamsList.querySelectorAll('.delete-team').forEach(b => b.addEventListener('click', (e)=>{
        const t = e.currentTarget.dataset.team;
        if (typeof window.__deleteTeam === 'function') window.__deleteTeam(t);
        else alert('Suppression √©quipe (simul√©e) : ' + t);
      }));
      adminTeamsList.querySelectorAll('.edit-team').forEach(b => b.addEventListener('click', (e)=>{
        const t = e.currentTarget.dataset.team;
        const newName = prompt('Nouveau nom de l‚Äô√©quipe', t);
        const newPwd = prompt('Nouveau mot de passe (laisser vide pour ne pas changer)');
        if (typeof window.__editTeam === 'function') window.__editTeam(t, newName, newPwd);
        else alert('Edition √©quipe (simul√©e): ' + newName + ' / ' + newPwd);
      }));
    }

    addTeamBtn.addEventListener('click', ()=> {
      const n = newTeamName.value.trim();
      const p = newTeamPwd.value.trim();
      if (!n || !p) { alert('Nom et mot de passe requis'); return; }
      if (typeof window.__addTeam === 'function') {
        window.__addTeam(n,p);
      } else {
        teamsList.push(n); renderAdminTeams(); alert('Ajout √©quipe (simul√©) : ' + n);
      }
      newTeamName.value = ''; newTeamPwd.value = '';
    });

    saveMaxBtn.addEventListener('click', ()=>{
      const v = parseInt(adminMax.value,10);
      if (isNaN(v) || v<=0) { alert('Valeur invalide'); return; }
      maxScore = v;
      // call cloud save in Part2
      if (typeof window.__saveMax === 'function') window.__saveMax(v);
      renderSelected();
    });

    // -------------------------
    // Local persistence (fast)
    // -------------------------
    function persistTeamLocal(){
      const state = { selectedUmas, currentTotal };
      localStorage.setItem('teamData_'+(currentTeam||'local'), JSON.stringify(state));
    }
    function loadTeamLocal(){
      try {
        const raw = localStorage.getItem('teamData_'+(currentTeam||'local'));
        if (!raw) return;
        const st = JSON.parse(raw);
        selectedUmas = st.selectedUmas || [];
        currentTotal = st.currentTotal || (selectedUmas.reduce((s,u)=>s+u.score,0));
      } catch(e){ /* ignore */ }
    }

    // on load: try resume session
    (function initFromLocal(){
      const s = localStorage.getItem('umaSession');
      if (s) {
        try {
          const obj = JSON.parse(s);
          if (obj && obj.team) {
            currentTeam = obj.team; isAdmin = obj.isAdmin || false;
            close(loginScreen);
            appContent.classList.remove('hidden');
            teamBadge.classList.remove('hidden');
            teamLabel.textContent = currentTeam;
            if (isAdmin) open(adminModal);
            loadTeamLocal();
            renderUmaList();
            renderSelected();
            // load cloud data in Part2 via __loadRemoteForTeam
            if (typeof window.__loadRemoteForTeam === 'function') window.__loadRemoteForTeam(currentTeam);
            return;
          }
        } catch(e){}
      }
      // otherwise show login
      open(loginScreen);
    })();

    // initial render
    renderUmaList();
    renderAdminUmaEdit();
    renderAdminTeams();

    // expose hooks to Part2 for cloud integration
    window.__uiHooks = {
      renderUmaList, renderSelected, renderAdminUmaEdit, renderAdminTeams,
      setUmas: (newUmas) => { umas = newUmas; renderUmaList(); renderAdminUmaEdit(); }
    };
    // ============================
    // Partie 2/2 - int√©gration Firebase
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, set, get, onValue, update, push, remove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  
    // ---------- CONFIG FIREBASE ----------
    // Remplace ce bloc par ta config (Project settings -> Web app)
    const firebaseConfig = {
      apiKey: "AIzaSyCKZBpYvgkTs-273GS9PHV9YIjlX6lIwKI",
      authDomain: "uma-selector-bdc59.firebaseapp.com",
      databaseURL: "https://uma-selector-bdc59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "uma-selector-bdc59",
      storageBucket: "uma-selector-bdc59.firebasestorage.app",
      messagingSenderId: "204929164113",
      appId: "1:204929164113:web:af408125a77c437a3f2970"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
  
    // ---------- R√©f√©rences ----------
    const configRef = ref(db, 'config');
    const teamsRef = ref(db, 'teams');
    const authRef = ref(db, 'auth');
  
    // ---------- √âtat local pour auth/config (peuvent changer en temps r√©el) ----------
    let authMap = {};    // { "Equipe 1": "pwd", "ADMIN": "toto3", ... }
    let config = { maxScore: 30, umas: [] };
    let teams = {};      // snapshot of teams node
  
    // ---------- Helpers pour UI (hooks expos√©s dans Part 1) ----------
    const ui = window.__uiHooks || {};
    const applyRemoteConfigToUI = () => {
      // ensure UI has up-to-date umas and maxScore
      if (Array.isArray(config.umas) && config.umas.length) {
        ui.setUmas(config.umas);
      }
      // update admin UI inputs
      const adminMax = document.getElementById('adminMax');
      if (adminMax) adminMax.value = config.maxScore || 30;
      const maxScoreEl = document.getElementById('maxScore');
      if (maxScoreEl) maxScoreEl.textContent = config.maxScore || 30;
    };
  
    // ---------- Listeners Realtime ----------
    onValue(configRef, snapshot => {
      const data = snapshot.val();
      if (!data) return;
      config = data;
      // keep local maxScore
      if (config.maxScore) {
        window.maxScore = config.maxScore;
      }
      applyRemoteConfigToUI();
      // re-render UI lists if needed
      if (ui.renderUmaList) ui.renderUmaList();
    });
  
    onValue(authRef, snapshot => {
      const data = snapshot.val() || {};
      authMap = data;
      // update teamSelect options if present
      loadTeamsListFromRemote();
    });
  
    onValue(teamsRef, snapshot => {
      teams = snapshot.val() || {};
      // update admin teams panel & team select
      loadTeamsListFromRemote();
      // If currentTeam is set, push remote state to UI (teams/<team>)
      if (window.currentTeam) {
        const teamNode = teams[window.currentTeam];
        if (teamNode) {
          // ensure UI displays remote selection
          if (typeof window.__umaApp !== 'undefined' && window.__umaApp.setStateFromRemote) {
            // compose combined state that Part1 expects
            const combined = {
              selectedUmas: teamNode.selectedUmas || [],
              total: teamNode.total || 0,
              config: config
            };
            window.__umaApp.setStateFromRemote(combined);
          }
        } else {
          // team node may not exist (newly created) ‚Äî create default
          set(ref(db, `teams/${window.currentTeam}`), { selectedUmas: [], total: 0 }).catch(console.error);
        }
      }
    });
  
    // ---------- Helper: update select/team list in UI ----------
    function loadTeamsListFromRemote() {
      const teamNames = Object.keys(teams || {});
      window.teamsList = teamNames;
      // update teamSelect in login screen
      const teamSelect = document.getElementById('teamSelect');
      if (teamSelect) {
        teamSelect.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '-- Choisir une √©quipe --';
        teamSelect.appendChild(placeholder);
        teamNames.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = t;
          teamSelect.appendChild(opt);
        });
      }
      // update admin teams panel
      if (ui.renderAdminTeams) {
        window.teamsList = teamNames;
        ui.renderAdminTeams();
      }
    }
  
    // ---------- Authentication helpers (used by Part1 login buttons) ----------
    // Validate team credentials (returns Promise<boolean>)
    window.__authClientValidate = async function(teamName, pwd) {
      // ensure authMap is loaded
      await get(authRef).catch(()=>{});
      const expected = authMap ? authMap[teamName] : undefined;
      // simple equality check; note: passwords are stored in DB in plain text here (see note)
      return expected && pwd === expected;
    };
  
    // Validate admin password (returns Promise<{ok:true, team?:...} | {ok:false}>)
    window.__adminValidate = async function(pwd) {
      await get(authRef).catch(()=>{});
      const adminPwd = authMap && authMap['ADMIN'];
      if (adminPwd && pwd === adminPwd) {
        // admin chooses which team to manage ‚Äî prefer existing currentTeam or default first team
        const firstTeam = Object.keys(teams)[0] || null;
        return { ok: true, team: firstTeam };
      }
      return { ok: false };
    };
  
    // ---------- Load remote data for a team and attach listeners ----------
    window.__loadRemoteForTeam = function(teamName) {
      if (!teamName) return;
      // attach onValue for this specific team
      const tRef = ref(db, `teams/${teamName}`);
      onValue(tRef, snapshot => {
        const data = snapshot.val() || { selectedUmas: [], total: 0 };
        // update UI
        if (typeof ui.renderSelected === 'function') {
          // set selectedUmas and total in Part1's global state
          window.selectedUmas = data.selectedUmas || [];
          window.currentTotal = data.total || (window.selectedUmas.reduce((s,u)=>s+(u.score||0),0));
          ui.renderSelected();
        } else {
          // fallback: set window state
          window.selectedUmas = data.selectedUmas || [];
          window.currentTotal = data.total || 0;
        }
      });
    };
  
    // ---------- Save team data (called when selecting/removing uma) ----------
    window.saveData = function() {
      if (!window.currentTeam) return;
      const payload = {
        selectedUmas: window.selectedUmas || [],
        total: window.currentTotal || ((window.selectedUmas||[]).reduce((s,u)=>s+(u.score||0),0))
      };
      set(ref(db, `teams/${window.currentTeam}`), payload).catch(err => console.error('saveData error', err));
    };
  
    // ---------- Admin functions: save config (maxScore + umas) ----------
    window.saveAdminConfig = function() {
      // config in memory updated by admin UI; push it
      const cfg = {
        maxScore: window.maxScore || config.maxScore || 30,
        umas: window.umas || (config.umas || [])
      };
      set(configRef, cfg).catch(err => console.error('saveAdminConfig error', err));
    };
  
    window.__saveMax = function(v) {
      if (isNaN(v) || v<=0) return;
      window.maxScore = v;
      saveAdminConfig();
    };
  
    // ---------- Admin: add team ----------
    window.__addTeam = function(name, pwd) {
      if (!name || !pwd) return;
      // create team node and add auth
      const updates = {};
      updates[`teams/${name}`] = { selectedUmas: [], total: 0 };
      updates[`auth/${name}`] = pwd;
      update(ref(db, '/'), updates).then(()=> {
        // refresh local state will be handled by onValue listeners
        alert('√âquipe ajout√©e : ' + name);
      }).catch(err => {
        console.error('addTeam error', err); alert('Erreur ajout √©quipe');
      });
    };
  
    // ---------- Admin: edit team (rename or change pwd) ----------
    window.__editTeam = async function(oldName, newName, newPwd) {
      if (!oldName) return;
      newName = newName && newName.trim() ? newName.trim() : oldName;
      // get current team node
      const oldRef = ref(db, `teams/${oldName}`);
      const snap = await get(oldRef);
      const data = snap.val();
      const updates = {};
      if (newName !== oldName) {
        // create new node and delete old one
        updates[`teams/${newName}`] = data || { selectedUmas: [], total: 0 };
        updates[`teams/${oldName}`] = null;
        // update auth key as well
        const currentPwd = authMap && authMap[oldName];
        if (currentPwd !== undefined) {
          updates[`auth/${newName}`] = currentPwd;
          updates[`auth/${oldName}`] = null;
        }
      }
      if (newPwd && newPwd.trim()) {
        updates[`auth/${newName}`] = newPwd.trim();
      }
      update(ref(db, '/'), updates).then(()=> {
        alert('√âquipe modifi√©e');
      }).catch(err => { console.error('editTeam error', err); alert('Erreur modification'); });
    };
  
    // ---------- Admin: delete team ----------
    window.__deleteTeam = function(name) {
      if (!name) return;
      // remove both team node and auth entry
      const updates = {};
      updates[`teams/${name}`] = null;
      updates[`auth/${name}`] = null;
      update(ref(db, '/'), updates).then(() => {
        alert('√âquipe supprim√©e : ' + name);
      }).catch(err => { console.error('deleteTeam error', err); alert('Erreur suppression'); });
    };
  
    // ---------- Utility: when UI changes selectedUmas locally, call saveData ----------
    // Hook into window.saveData usage: Part1 calls saveData() after actions; ensure availability
    window.saveData = window.saveData || function(){ if (typeof window.saveData === 'function') window.saveData(); };
  
    // ---------- Expose some extra hooks for debug ----------
    window.__debug = {
      authMap: () => authMap,
      config: () => config,
      teams: () => teams
    };
  
    // ---------- Initial load: fetch current values once to seed UI ----------
    (async function initialSeed() {
      try {
        const cfgSnap = await get(configRef);
        if (cfgSnap.exists()) config = cfgSnap.val();
        // set initial umas into UI hook
        if (config && config.umas && config.umas.length) {
          window.umas = config.umas;
          if (ui.setUmas) ui.setUmas(config.umas);
        }
        // load auth & teams
        const a = await get(authRef);
        authMap = a.exists() ? a.val() : {};
        const t = await get(teamsRef);
        teams = t.exists() ? t.val() : {};
        loadTeamsListFromRemote();
        // If session exists, reattach listener for that team
        try {
          const session = JSON.parse(localStorage.getItem('umaSession') || '{}');
          if (session && session.team) {
            window.currentTeam = session.team; window.isAdmin = session.isAdmin;
            // ensure UI reflects team & admin
            document.getElementById('teamLabel').textContent = window.currentTeam || '';
            if (ui.renderUmaList) ui.renderUmaList();
            if (typeof window.__loadRemoteForTeam === 'function') window.__loadRemoteForTeam(window.currentTeam);
          }
        } catch(e){}
      } catch(err) {
        console.error('initialSeed error', err);
      }
    })();
  
    // ---------- Make sure Part1 hooks call these functions ----------
    // Part1 calls saveData() and saveAdminConfig(); ensure those are defined
    window.saveData = function() {
      if (!window.currentTeam) {
        console.warn('No team selected; skip saveData');
        return;
      }
      const payload = {
        selectedUmas: window.selectedUmas || [],
        total: window.currentTotal || (window.selectedUmas||[]).reduce((s,u)=>s+(u.score||0),0)
      };
      set(ref(db, `teams/${window.currentTeam}`), payload).catch(e=>console.error(e));
    };
  
    window.saveAdminConfig = function() {
      const cfg = { maxScore: window.maxScore || config.maxScore || 30, umas: window.umas || config.umas || [] };
      set(configRef, cfg).catch(e=>console.error(e));
    };
  
    // ---------- Done ----------
    console.log('Firebase integration ready. Replace firebaseConfig with yours if not done yet.');
  </script>
</body>
</html>
