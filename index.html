<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Uma Musume Team Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-pink-100 to-purple-200 min-h-screen font-sans">

  <!-- HEADER -->
  <header class="flex justify-between items-center p-4 bg-pink-400 text-white shadow-md">
    <h1 class="text-2xl font-bold">üêé Uma Musume Team Builder</h1>
    <div class="flex items-center space-x-4">
      <span id="teamLabel" class="font-semibold">Aucune √©quipe</span>
      <button id="changeTeamBtn" class="bg-white text-pink-600 px-3 py-1 rounded-lg hover:bg-pink-50 shadow">Changer d'√©quipe</button>
      <button id="adminBtn" class="bg-purple-600 px-3 py-1 rounded-lg hover:bg-purple-700">Mode Admin</button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main id="mainContent" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
    
    <!-- COLONNE GAUCHE - LISTE UMA -->
    <section class="bg-white rounded-2xl shadow p-4 flex flex-col">
      <input id="searchInput" type="text" placeholder="Rechercher une Uma..." class="border rounded p-2 mb-3" />
      <div id="umaList" class="overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
    </section>

    <!-- COLONNE DROITE - S√âLECTION -->
    <section class="bg-white rounded-2xl shadow p-4 relative">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-bold">√âquipe s√©lectionn√©e</h2>
        <div id="scoreDisplay" class="text-3xl font-extrabold text-green-600">
          0 / <span id="maxScore">30</span>
        </div>
      </div>
      <div id="selectedUmas" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    </section>

  </main>

  <!-- MODALE CONNEXION √âQUIPE -->
  <div id="teamModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 shadow-lg w-80">
      <h2 class="text-xl font-bold text-pink-600 mb-4 text-center">Connexion √âquipe</h2>
      <label class="block mb-2">Choisir une √©quipe :</label>
      <select id="teamSelect" class="border w-full p-2 rounded mb-3"></select>
      <label class="block mb-2">Mot de passe :</label>
      <input id="teamPasswordInput" type="password" class="border w-full p-2 rounded mb-4" />
      <div class="flex justify-end space-x-2">
        <button id="teamCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="teamConfirm" class="px-3 py-1 rounded bg-pink-500 text-white hover:bg-pink-600">Connexion</button>
      </div>
    </div>
  </div>

  <!-- MODALE CONNEXION ADMIN -->
  <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 shadow-lg w-80">
      <h2 class="text-xl font-bold text-purple-600 mb-4 text-center">Connexion Admin</h2>
      <label class="block mb-2">Mot de passe admin :</label>
      <input id="adminPwdInput" type="password" class="border w-full p-2 rounded mb-4" />
      <div class="flex justify-end space-x-2">
        <button id="adminCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="adminConfirm" class="px-3 py-1 rounded bg-purple-500 text-white hover:bg-purple-600">Connexion</button>
      </div>
    </div>
  </div>

  <!-- MODALE NOM PERSONNALIS√â -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 shadow-lg w-80">
      <h2 class="text-xl font-bold mb-4 text-pink-600">Pseudonyme</h2>
      <input id="customNameInput" type="text" class="border w-full p-2 rounded mb-4" placeholder="Entrer un nom personnalis√©..." />
      <div class="flex justify-end space-x-2">
        <button id="nameCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="nameConfirm" class="px-3 py-1 rounded bg-pink-500 text-white hover:bg-pink-600">Valider</button>
      </div>
    </div>
  </div>

  <!-- MODALE CONFIRMATION SUPPRESSION -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 shadow-lg w-80">
      <h2 class="text-xl font-bold text-red-600 mb-4">Supprimer cette Uma ?</h2>
      <div class="flex justify-end space-x-2">
        <button id="confirmNo" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="confirmYes" class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- SECTION ADMIN (cach√©e sauf admin connect√©) -->
  <section id="adminPanel" class="hidden bg-white rounded-2xl shadow p-4 m-4">
    <h2 class="text-xl font-bold mb-3 text-purple-700">‚öôÔ∏è Panneau d'administration</h2>
    <div class="mb-4">
      <label class="block mb-1 font-semibold">Score maximum :</label>
      <input id="adminMaxInput" type="number" class="border p-2 rounded w-24" min="1" value="30" />
      <button id="saveMaxBtn" class="bg-purple-500 text-white px-3 py-1 rounded ml-2 hover:bg-purple-600">üíæ Sauvegarder</button>
    </div>
    <h3 class="text-lg font-bold mb-2">√âquipes existantes :</h3>
    <div id="teamsAdminList" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4"></div>
    <div class="border-t pt-3">
      <h3 class="text-lg font-bold mb-2">‚ûï Ajouter une nouvelle √©quipe</h3>
      <input id="newTeamName" type="text" placeholder="Nom √©quipe" class="border p-2 rounded w-full mb-2" />
      <input id="newTeamPwd" type="password" placeholder="Mot de passe" class="border p-2 rounded w-full mb-2" />
      <button id="addTeamBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Ajouter</button>
    </div>
  </section>

  <!-- SCRIPTS PRINCIPAUX -->
  <script>
    // Petite animation d'entr√©e
    window.addEventListener('load', () => {
      document.body.classList.add('transition-all');
    });
  </script>  <!-- FIREBASE SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /* üî• Configuration Firebase ‚Äî adapte avec ta propre config */
    const firebaseConfig = {
      apiKey: "AIzaSyCKZBpYvgkTs-273GS9PHV9YIjlX6lIwKI",
      authDomain: "uma-selector-bdc59.firebaseapp.com",
      databaseURL: "https://uma-selector-bdc59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "uma-selector-bdc59",
      storageBucket: "uma-selector-bdc59.firebasestorage.app",
      messagingSenderId: "204929164113",
      appId: "1:204929164113:web:af408125a77c437a3f2970"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* === VARIABLES === */
    let currentTeam = null;
    let isAdmin = false;
    let umaList = [];
    let selectedUma = null;
    let pendingDelete = null;
    let teamsData = {};
    let maxScore = 30;
    let teamAuth = {};

    /* === R√âF√âRENCES DOM === */
    const umaListDiv = document.getElementById("umaList");
    const selectedUmasDiv = document.getElementById("selectedUmas");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const maxScoreSpan = document.getElementById("maxScore");
    const teamLabel = document.getElementById("teamLabel");
    const mainContent = document.getElementById("mainContent");
    const adminPanel = document.getElementById("adminPanel");
    const searchInput = document.getElementById("searchInput");

    // Modales
    const teamModal = document.getElementById("teamModal");
    const adminModal = document.getElementById("adminModal");
    const nameModal = document.getElementById("nameModal");
    const confirmModal = document.getElementById("confirmModal");

    /* === CHARGEMENT INITIAL === */
    async function initApp() {
      // Charger les donn√©es Uma
      let umaList = [
      { id: "special-week", name: "Special Week", img: "https://static.wikia.nocookie.net/umamusume/images/8/8e/Special_Week_Portrait.png", score: 5 },
      { id: "silence-suzuka", name: "Silence Suzuka", img: "https://static.wikia.nocookie.net/umamusume/images/a/a4/Silence_Suzuka_Portrait.png", score: 4 },
      { id: "tokai-teio", name: "Tokai Teio", img: "https://static.wikia.nocookie.net/umamusume/images/1/12/Tokai_Teio_Portrait.png", score: 5 },
      { id: "mejiro-mcqueen", name: "Mejiro McQueen", img: "https://static.wikia.nocookie.net/umamusume/images/7/7f/Mejiro_McQueen_Portrait.png", score: 3 },
      { id: "gold-ship", name: "Gold Ship", img: "https://static.wikia.nocookie.net/umamusume/images/e/e5/Gold_Ship_Portrait.png", score: 4 },
      { id: "daiwa-scarlet", name: "Daiwa Scarlet", img: "https://static.wikia.nocookie.net/umamusume/images/b/b0/Daiwa_Scarlet_Portrait.png", score: 2 },
      { id: "vodka", name: "Vodka", img: "https://static.wikia.nocookie.net/umamusume/images/6/6d/Vodka_Portrait.png", score: 3 },
      { id: "grass-wonder", name: "Grass Wonder", img: "https://static.wikia.nocookie.net/umamusume/images/9/9c/Grass_Wonder_Portrait.png", score: 1 },
      { id: "el-condor-pasa", name: "El Condor Pasa", img: "https://static.wikia.nocookie.net/umamusume/images/a/aa/El_Condor_Pasa_Portrait.png", score: 2 },
      { id: "tm-opera-o", name: "TM Opera O", img: "https://static.wikia.nocookie.net/umamusume/images/0/07/TM_Opera_O_Portrait.png", score: 1 }
      ];

      renderUmaList();

      // Charger √©quipes et auth depuis Firebase
      const snapshot = await get(ref(db, "/"));
      if (snapshot.exists()) {
        const data = snapshot.val();
        teamsData = data.teams || {};
        teamAuth = data.auth || {};
        maxScore = data.maxScore || 30;
        maxScoreSpan.textContent = maxScore;
      }
      updateTeamSelect();
      // Si une √©quipe est stock√©e localement
      const savedTeam = localStorage.getItem("currentTeam");
      if (savedTeam) {
        currentTeam = savedTeam;
        teamLabel.textContent = "√âquipe : " + currentTeam;
        mainContent.classList.remove("hidden");
        __loadRemoteForTeam(currentTeam);
      } else {
        openTeamModal();
      }
    }

    /* === RENDER LISTE UMA === */
    function renderUmaList(filter = "") {
      umaListDiv.innerHTML = "";
      umaList
        .filter(u => u.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach(u => {
          const div = document.createElement("div");
          div.className = "border rounded-lg p-2 flex flex-col items-center cursor-pointer hover:bg-pink-50 transition";
          div.innerHTML = `
            <img src="${u.imageUrl || 'https://via.placeholder.com/80'}" alt="${u.name}" class="w-20 h-20 object-cover rounded-full mb-2">
            <span class="font-semibold text-sm text-center">${u.name}</span>
            <span class="text-yellow-600 text-xs">Score : ${u.score || 3}</span>
          `;
          div.addEventListener("click", () => openNameModal(u));
          umaListDiv.appendChild(div);
        });
    }

    searchInput.addEventListener("input", e => renderUmaList(e.target.value));

    /* === AJOUT UMA === */
    function openNameModal(uma) {
      selectedUma = uma;
      nameModal.classList.remove("hidden", "opacity-0");
    }

    document.getElementById("nameCancel").onclick = () => {
      nameModal.classList.add("hidden");
      selectedUma = null;
    };

    document.getElementById("nameConfirm").onclick = async () => {
      const name = document.getElementById("customNameInput").value.trim();
      if (!name || !selectedUma) return;
      await addUmaToTeam(selectedUma, name);
      document.getElementById("customNameInput").value = "";
      nameModal.classList.add("hidden");
      selectedUma = null;
    };

    async function addUmaToTeam(uma, customName) {
      if (!currentTeam) return;
      const teamRef = ref(db, `teams/${currentTeam}/members`);
      const snapshot = await get(teamRef);
      const members = snapshot.exists() ? snapshot.val() : [];

      const newMember = {
        name: uma.name,
        customName,
        score: uma.score || 3,
        image: uma.imageUrl || 'https://via.placeholder.com/80'
      };
      members.push(newMember);
      await set(teamRef, members);
    }

    /* === SUPPRESSION UMA === */
    function openConfirmModal(umaIndex) {
      pendingDelete = umaIndex;
      confirmModal.classList.remove("hidden");
    }
    document.getElementById("confirmNo").onclick = () => confirmModal.classList.add("hidden");
    document.getElementById("confirmYes").onclick = async () => {
      if (pendingDelete !== null) {
        await removeUmaFromTeam(pendingDelete);
        confirmModal.classList.add("hidden");
        pendingDelete = null;
      }
    };

    async function removeUmaFromTeam(index) {
      const teamRef = ref(db, `teams/${currentTeam}/members`);
      const snapshot = await get(teamRef);
      if (!snapshot.exists()) return;
      const members = snapshot.val();
      members.splice(index, 1);
      await set(teamRef, members);
    }

    /* === CHARGEMENT DES MEMBRES D'√âQUIPE === */
    function __loadRemoteForTeam(teamName) {
      const teamRef = ref(db, `teams/${teamName}`);
      onValue(teamRef, (snap) => {
        if (!snap.exists()) {
          selectedUmasDiv.innerHTML = "<p class='text-gray-500 italic'>Aucune Uma s√©lectionn√©e</p>";
          scoreDisplay.textContent = `0 / ${maxScore}`;
          return;
        }
        const data = snap.val();
        const members = data.members || [];
        renderTeamMembers(members);
      });
    }

    function renderTeamMembers(members) {
      selectedUmasDiv.innerHTML = "";
      let total = 0;
      members.forEach((m, i) => {
        total += m.score;
        const card = document.createElement("div");
        card.className = "border rounded-lg p-2 relative";
        card.innerHTML = `
          <button class="absolute top-1 right-1 text-red-500 font-bold">‚úï</button>
          <img src="${m.image}" class="w-20 h-20 object-cover rounded-full mx-auto mb-2">
          <p class="font-semibold text-center">${m.name}</p>
          <p class="text-sm text-gray-500 text-center">${m.customName}</p>
          <p class="text-center text-yellow-600">Score : ${m.score}</p>
        `;
        card.querySelector("button").onclick = () => openConfirmModal(i);
        selectedUmasDiv.appendChild(card);
      });

      const scoreColor = total <= maxScore ? "text-green-600" : "text-red-600";
      scoreDisplay.className = `text-3xl font-extrabold ${scoreColor}`;
      scoreDisplay.innerHTML = `${total} / <span id="maxScore">${maxScore}</span>`;
    }

    /* === MODALE √âQUIPE === */
    function openTeamModal() {
      teamModal.classList.remove("hidden");
      updateTeamSelect();
    }

    function updateTeamSelect() {
      const select = document.getElementById("teamSelect");
      select.innerHTML = Object.keys(teamsData)
        .map(k => `<option value="${k}">${k}</option>`)
        .join("");
    }

    document.getElementById("changeTeamBtn").onclick = openTeamModal;
    document.getElementById("teamCancel").onclick = () => teamModal.classList.add("hidden");
    document.getElementById("teamConfirm").onclick = async () => {
      const selected = document.getElementById("teamSelect").value;
      const pwd = document.getElementById("teamPasswordInput").value.trim();
      if (pwd === teamAuth[selected]) {
        currentTeam = selected;
        localStorage.setItem("currentTeam", selected);
        teamLabel.textContent = "√âquipe : " + selected;
        teamModal.classList.add("hidden");
        mainContent.classList.remove("hidden");
        adminPanel.classList.add("hidden");
        __loadRemoteForTeam(currentTeam);
      } else {
        alert("Mot de passe incorrect !");
      }
    };

    /* === ADMIN === */
    document.getElementById("adminBtn").onclick = () => adminModal.classList.remove("hidden");
    document.getElementById("adminCancel").onclick = () => adminModal.classList.add("hidden");
    document.getElementById("adminConfirm").onclick = () => {
      const pwd = document.getElementById("adminPwdInput").value.trim();
      if (pwd === teamAuth["Admin"]) {
        isAdmin = true;
        adminModal.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        mainContent.classList.remove("hidden");
        renderAdminTeams();
      } else {
        alert("Mot de passe admin incorrect !");
      }
    };

    function renderAdminTeams() {
      const container = document.getElementById("teamsAdminList");
      container.innerHTML = "";
      Object.keys(teamAuth).forEach(team => {
        if (team === "Admin") return;
        const div = document.createElement("div");
        div.className = "border p-3 rounded";
        div.innerHTML = `
          <label class="block text-sm font-semibold mb-1">${team}</label>
          <input type="text" value="${team}" class="border p-1 rounded w-full mb-1 teamNameEdit">
          <input type="password" value="${teamAuth[team]}" class="border p-1 rounded w-full mb-2 teamPwdEdit">
          <button class="bg-purple-500 text-white rounded px-2 py-1 w-full hover:bg-purple-600">üíæ Enregistrer</button>
        `;
        div.querySelector("button").onclick = async () => {
          const newName = div.querySelector(".teamNameEdit").value.trim();
          const newPwd = div.querySelector(".teamPwdEdit").value.trim();
          await update(ref(db, "auth/" + team), newPwd);
          if (newName !== team) {
            await update(ref(db, "auth/" + newName), newPwd);
            await set(ref(db, "auth/" + team), null);
          }
          alert("√âquipe mise √† jour !");
        };
        container.appendChild(div);
      });
    }

    document.getElementById("saveMaxBtn").onclick = async () => {
      const val = parseInt(document.getElementById("adminMaxInput").value);
      if (!isNaN(val)) {
        await set(ref(db, "maxScore"), val);
        maxScore = val;
        maxScoreSpan.textContent = maxScore;
        alert("Score max mis √† jour !");
      }
    };

    document.getElementById("addTeamBtn").onclick = async () => {
      const name = document.getElementById("newTeamName").value.trim();
      const pwd = document.getElementById("newTeamPwd").value.trim();
      if (!name || !pwd) return alert("Nom et mot de passe requis !");
      await update(ref(db, "auth/" + name), pwd);
      await set(ref(db, "teams/" + name), { members: [] });
      alert("Nouvelle √©quipe ajout√©e !");
      document.getElementById("newTeamName").value = "";
      document.getElementById("newTeamPwd").value = "";
      initApp();
    };

    /* === INITIALISATION === */
    initApp();

  </script>
</body>
</html>
