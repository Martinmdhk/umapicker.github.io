<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Uma Musume - S√©lecteur d'√©quipe (Firebase)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; transition: background 0.5s ease; }
    .card-hover:hover { transform: translateY(-4px); transition: transform .18s ease; }
    .modal-backdrop { background: rgba(0,0,0,0.45); }
    ::-webkit-scrollbar { height:8px; width:8px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }
    #scoreDisplay { font-size: 2rem; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.5rem; }
  </style>
</head>
<body>

  <!-- CONTENU PRINCIPAL, masqu√© tant qu'aucune √©quipe n'est choisie -->
  <div id="appContent" class="hidden min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="flex items-center justify-between p-4 bg-white/70 border-b border-pink-200">
      <div class="flex items-center gap-4">
        <div class="text-2xl font-bold text-pink-600">üêé Uma Selector</div>
        <div id="currentTeamBadge" class="text-sm text-gray-600 hidden">√âquipe: <span id="teamNameDisplay" class="font-semibold"></span></div>
      </div>
      <div class="flex items-center gap-3">
        <button id="changeTeamBtn" class="text-sm px-3 py-1 rounded bg-pink-100 text-pink-700 hidden">Changer d'√©quipe</button>
        <button id="adminToggleBtn" class="text-sm px-3 py-1 rounded bg-gray-100 text-gray-800 hidden">Mode admin</button>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex flex-1">
      <!-- LEFT: Liste et recherche -->
      <aside class="w-1/3 p-4 overflow-auto border-r border-pink-200 bg-white/70">
        <h2 class="text-lg font-semibold text-pink-600 mb-3">Liste des Uma</h2>
        <input id="searchInput" type="search" placeholder="Rechercher..." class="w-full p-2 border border-pink-200 rounded mb-3">
        <div id="umaList" class="grid grid-cols-2 gap-3"></div>
      </aside>

      <!-- RIGHT: S√©lection -->
      <section class="flex-1 p-6 overflow-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-pink-600">S√©lection</h2>
          <div id="scoreDisplay">
            <span id="totalScore" class="inline-block mr-1 text-green-600">0</span>
            /
            <span id="maxScore" class="inline-block ml-1 text-gray-700">30</span>
          </div>
        </div>
        <div id="selectedArea" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      </section>
    </main>
  </div>

  <!-- -----------------------------
       MODALES
       ----------------------------- -->

  <!-- Modal choix √©quipe -->
  <div id="teamModal" class="fixed inset-0 flex items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-xl font-semibold mb-4">Choisissez votre √©quipe</h3>
      <div class="flex flex-col gap-3">
        <button class="teamBtn px-4 py-2 rounded bg-pink-500 text-white" data-team="Equipe 1">√âquipe 1</button>
        <button class="teamBtn px-4 py-2 rounded bg-blue-500 text-white" data-team="Equipe 2">√âquipe 2</button>
      </div>
      <div class="pt-3 border-t mt-3">
        <div class="text-sm text-gray-600 mb-2">Ou entrez le mot de passe pour vous connecter :</div>
        <input id="teamPasswordInput" type="password" class="w-full p-2 border rounded" placeholder="Mot de passe...">
        <div class="flex gap-2 mt-3">
          <button id="teamPasswordOk" class="px-3 py-1 bg-green-500 text-white rounded">Se connecter</button>
          <button id="teamPasswordCancel" class="px-3 py-1 bg-gray-100 rounded">Annuler</button>
        </div>
        <p id="teamPwdError" class="text-red-600 text-sm mt-2 hidden">Mot de passe incorrect</p>
      </div>
    </div>
  </div>

  <!-- Modal entrer nom personnalis√© -->
  <div id="nameModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-lg font-semibold mb-3">Nom personnalis√©</h3>
      <div class="text-sm text-gray-700 mb-2">Pour : <span id="nameModalUma"></span></div>
      <input id="customNameInput" type="text" class="w-full p-2 border rounded" placeholder="Entrez le nom personnalis√©..." maxlength="30">
      <div class="flex justify-end gap-2 mt-4">
        <button id="nameCancelBtn" class="px-3 py-1 bg-gray-100 rounded">Annuler</button>
        <button id="nameOkBtn" class="px-3 py-1 bg-pink-500 text-white rounded">Valider</button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation suppression -->
  <div id="confirmModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-lg font-semibold mb-3">Confirmer la suppression</h3>
      <p id="confirmText" class="text-sm text-gray-700 mb-4">√ätes-vous s√ªr ?</p>
      <div class="flex justify-end gap-2">
        <button id="confirmCancel" class="px-3 py-1 bg-gray-100 rounded">Annuler</button>
        <button id="confirmOk" class="px-3 py-1 bg-red-500 text-white rounded">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Modal mot de passe admin -->
  <div id="adminPasswordModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-lg font-semibold mb-3">Mot de passe administrateur</h3>
      <input id="adminPasswordInput" type="password" class="w-full p-2 border rounded" placeholder="Entrez le mot de passe admin...">
      <div class="flex justify-end gap-2 mt-4">
        <button id="adminPwdCancel" class="px-3 py-1 bg-gray-100 rounded">Annuler</button>
        <button id="adminPwdOk" class="px-3 py-1 bg-green-500 text-white rounded">Valider</button>
      </div>
      <p id="adminPwdError" class="text-red-600 text-sm mt-2 hidden">Mot de passe incorrect</p>
    </div>
  </div>

  <!-- Modal admin (√©diter scores et max) -->
  <div id="adminModal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6">
      <h3 class="text-lg font-semibold mb-3">Mode administrateur</h3>
      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Score maximum</label>
        <input id="adminMaxInput" type="number" min="1" class="w-full p-2 border rounded">
      </div>
      <div class="mb-3">
        <label class="block text-sm text-gray-600 mb-1">Rechercher Uma √† √©diter</label>
        <input id="adminSearch" type="text" placeholder="Rechercher..." class="w-full p-2 border rounded">
      </div>
      <div id="adminUmaList" class="max-h-48 overflow-auto grid grid-cols-1 gap-2 mb-3"></div>
      <div class="flex justify-end gap-2">
        <button id="adminClose" class="px-3 py-1 bg-gray-100 rounded">Fermer</button>
        <button id="adminSave" class="px-3 py-1 bg-green-500 text-white rounded">Sauvegarder</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT Partie 1/2 : Variables, modales, DOM, structure Uma -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /* ======================
       CONFIG FIREBASE
       ====================== */
    const firebaseConfig = {
      apiKey: "TON_API_KEY_ICI",
      authDomain: "ton-projet.firebaseapp.com",
      databaseURL: "https://ton-projet-default-rtdb.firebaseio.com",
      projectId: "ton-projet",
      storageBucket: "ton-projet.appspot.com",
      messagingSenderId: "0000000000",
      appId: "1:0000000000:web:xxxxxx"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ======================
       VARIABLES DOM
       ====================== */
    const appContent = document.getElementById('appContent');
    const teamModal = document.getElementById('teamModal');
    const teamPasswordInput = document.getElementById('teamPasswordInput');
    const teamPwdError = document.getElementById('teamPwdError');
    const adminPasswordModal = document.getElementById('adminPasswordModal');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const adminPwdError = document.getElementById('adminPwdError');

    const nameModal = document.getElementById('nameModal');
    const nameModalUma = document.getElementById('nameModalUma');
    const customNameInput = document.getElementById('customNameInput');
    const nameOkBtn = document.getElementById('nameOkBtn');
    const nameCancelBtn = document.getElementById('nameCancelBtn');

    const confirmModal = document.getElementById('confirmModal');
    const confirmText = document.getElementById('confirmText');
    const confirmOk = document.getElementById('confirmOk');
    const confirmCancel = document.getElementById('confirmCancel');

    const adminModal = document.getElementById('adminModal');
    const adminMaxInput = document.getElementById('adminMaxInput');

    const adminSearch = document.getElementById('adminSearch');
    const adminUmaList = document.getElementById('adminUmaList');
    const adminClose = document.getElementById('adminClose');
    const adminSave = document.getElementById('adminSave');

    const changeTeamBtn = document.getElementById('changeTeamBtn');
    const adminToggleBtn = document.getElementById('adminToggleBtn');
    const teamNameDisplay = document.getElementById('teamNameDisplay');
    const currentTeamBadge = document.getElementById('currentTeamBadge');

    const searchInput = document.getElementById('searchInput');
    const umaList = document.getElementById('umaList');
    const selectedArea = document.getElementById('selectedArea');
    const totalScoreElem = document.getElementById('totalScore');
    const maxScoreElem = document.getElementById('maxScore');
    const scoreDisplay = document.getElementById('scoreDisplay');

    /* ======================
       VARIABLES APP
       ====================== */
    let currentTeam = localStorage.getItem('currentTeam') || null;
    let isAdmin = false;
    let umas = [
      // Exemple minimal, ajouter toutes les umas ici
      { id:1, name:"Uma1", img:"https://via.placeholder.com/80", score:5 },
      { id:2, name:"Uma2", img:"https://via.placeholder.com/80", score:4 },
      { id:3, name:"Uma3", img:"https://via.placeholder.com/80", score:3 },
    ];
    let selectedUmas = [];
    let currentTotal = 0;
    let maxScore = 30;
    let tempUma = null;
    let tempDeleteIndex = null;

    /* ======================
       UTILITAIRES MODALES
       ====================== */
    function openModal(modal){ modal.classList.remove('hidden'); }
    function closeModal(modal){ modal.classList.add('hidden'); }

    /* ======================
       UPDATE BACKGROUND selon √©quipe
       ====================== */
    function updateBackground() {
      if(currentTeam==="Equipe 1") document.body.style.background = "linear-gradient(to right, #ffe0e0, #fff0f0)";
      else if(currentTeam==="Equipe 2") document.body.style.background = "linear-gradient(to right, #e0f0ff, #f0f8ff)";
      else document.body.style.background = "#fff";
    }

    /* ======================
       GESTION EQUIPE
       ====================== */
    function applyTeam(team){
      currentTeam = team;
      localStorage.setItem('currentTeam', team);
      teamNameDisplay.textContent = team;
      currentTeamBadge.classList.remove('hidden');
      changeTeamBtn.classList.remove('hidden');
      adminToggleBtn.classList.remove('hidden');
      appContent.classList.remove('hidden');
      closeModal(teamModal);
      updateBackground();
      loadData();
    }

    document.querySelectorAll('.teamBtn').forEach(btn=>{
      btn.addEventListener('click',()=>applyTeam(btn.dataset.team));
    });

    document.getElementById('teamPasswordOk').addEventListener('click',()=>{
      const pwd = teamPasswordInput.value.trim();
      if(pwd==="toto") applyTeam("Equipe 1");
      else if(pwd==="toto2") applyTeam("Equipe 2");
      else teamPwdError.classList.remove('hidden');
    });

    document.getElementById('teamPasswordCancel').addEventListener('click',()=>closeModal(teamModal));
    changeTeamBtn.addEventListener('click',()=>openModal(teamModal));

    /* ======================
       VARIABLES DOM Suite
       ====================== */
    const adminSearch = document.getElementById('adminSearch');
    const adminUmaList = document.getElementById('adminUmaList');
    const adminClose = document.getElementById('adminClose');
    const adminSave = document.getElementById('adminSave');

    const changeTeamBtn = document.getElementById('changeTeamBtn');
    const adminToggleBtn = document.getElementById('adminToggleBtn');
    const teamNameDisplay = document.getElementById('teamNameDisplay');
    const currentTeamBadge = document.getElementById('currentTeamBadge');

    const searchInput = document.getElementById('searchInput');
    const umaList = document.getElementById('umaList');
    const selectedArea = document.getElementById('selectedArea');
    const totalScoreElem = document.getElementById('totalScore');
    const maxScoreElem = document.getElementById('maxScore');
    const scoreDisplay = document.getElementById('scoreDisplay');

    /* ======================
       VARIABLES APP
       ====================== */
    let currentTeam = localStorage.getItem('currentTeam') || null;
    let isAdmin = false;
    let umas = [
      // Exemple minimal, ajouter toutes les umas ici
      { id:1, name:"Uma1", img:"https://via.placeholder.com/80", score:5 },
      { id:2, name:"Uma2", img:"https://via.placeholder.com/80", score:4 },
      { id:3, name:"Uma3", img:"https://via.placeholder.com/80", score:3 },
    ];
    let selectedUmas = [];
    let currentTotal = 0;
    let maxScore = 30;
    let tempUma = null;
    let tempDeleteIndex = null;

    /* ======================
       UTILITAIRES MODALES
       ====================== */
    function openModal(modal){ modal.classList.remove('hidden'); }
    function closeModal(modal){ modal.classList.add('hidden'); }

    /* ======================
       UPDATE BACKGROUND selon √©quipe
       ====================== */
    function updateBackground() {
      if(currentTeam==="Equipe 1") document.body.style.background = "linear-gradient(to right, #ffe0e0, #fff0f0)";
      else if(currentTeam==="Equipe 2") document.body.style.background = "linear-gradient(to right, #e0f0ff, #f0f8ff)";
      else document.body.style.background = "#fff";
    }

    /* ======================
       GESTION EQUIPE
       ====================== */
    function applyTeam(team){
      currentTeam = team;
      localStorage.setItem('currentTeam', team);
      teamNameDisplay.textContent = team;
      currentTeamBadge.classList.remove('hidden');
      changeTeamBtn.classList.remove('hidden');
      adminToggleBtn.classList.remove('hidden');
      appContent.classList.remove('hidden');
      closeModal(teamModal);
      updateBackground();
      loadData();
    }

    document.querySelectorAll('.teamBtn').forEach(btn=>{
      btn.addEventListener('click',()=>applyTeam(btn.dataset.team));
    });

    document.getElementById('teamPasswordOk').addEventListener('click',()=>{
      const pwd = teamPasswordInput.value.trim();
      if(pwd==="toto") applyTeam("Equipe 1");
      else if(pwd==="toto2") applyTeam("Equipe 2");
      else teamPwdError.classList.remove('hidden');
    });

    document.getElementById('teamPasswordCancel').addEventListener('click',()=>closeModal(teamModal));
    changeTeamBtn.addEventListener('click',()=>openModal(teamModal));

    /* ======================
       RENDER LISTE UMA
       ====================== */
    function renderList(filter=""){
      umaList.innerHTML="";
      const f = filter.toLowerCase();
      umas.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
        const div = document.createElement('div');
        div.className = "p-2 border rounded cursor-pointer card-hover flex flex-col items-center";
        div.innerHTML=`<img src="${u.img}" class="w-20 h-20 object-cover mb-1"><div class="text-sm font-semibold">${u.name}</div><div class="text-xs text-gray-500">Score: ${u.score}</div>`;
        div.addEventListener('click',()=>selectUma(u));
        umaList.appendChild(div);
      });
    }
    searchInput.addEventListener('input',()=>renderList(searchInput.value));

    /* ======================
       SELECTION UMA
       ====================== */
    function selectUma(uma){
      tempUma = uma;
      nameModalUma.textContent = uma.name;
      customNameInput.value="";
      openModal(nameModal);
    }

    nameOkBtn.addEventListener('click',()=>{
      if(!customNameInput.value.trim()) return alert("Veuillez entrer un nom");
      selectedUmas.push({ ...tempUma, customName:customNameInput.value.trim() });
      currentTotal += tempUma.score;
      renderSelected();
      saveData();
      closeModal(nameModal);
    });

    nameCancelBtn.addEventListener('click',()=>closeModal(nameModal));

    /* ======================
       RENDER SELECTED
       ====================== */
    function renderSelected(){
      selectedArea.innerHTML="";
      selectedUmas.forEach((u,i)=>{
        const div = document.createElement('div');
        div.className="p-2 border rounded relative flex flex-col items-center";
        div.innerHTML=`<img src="${u.img}" class="w-24 h-24 object-cover mb-1"><div class="text-sm font-semibold">${u.customName}</div><div class="absolute top-1 right-1 cursor-pointer text-red-500 font-bold">√ó</div>`;
        div.querySelector('div.absolute').addEventListener('click',()=>{
          tempDeleteIndex=i;
          confirmText.textContent=`Supprimer ${u.customName} ?`;
          openModal(confirmModal);
        });
        selectedArea.appendChild(div);
      });
      totalScoreElem.textContent = currentTotal;
      maxScoreElem.textContent = maxScore;
      if(currentTotal<=maxScore) totalScoreElem.className="inline-block mr-1 text-green-600";
      else totalScoreElem.className="inline-block mr-1 text-red-600";
    }

    confirmOk.addEventListener('click',()=>{
      currentTotal -= selectedUmas[tempDeleteIndex].score;
      selectedUmas.splice(tempDeleteIndex,1);
      renderSelected();
      saveData();
      closeModal(confirmModal);
    });

    confirmCancel.addEventListener('click',()=>closeModal(confirmModal));

    /* ======================
       MODE ADMIN
       ====================== */
    adminToggleBtn.addEventListener('click',()=>openModal(adminPasswordModal));

    document.getElementById('adminPwdOk').addEventListener('click',()=>{
      if(adminPasswordInput.value.trim()==="toto3"){
        isAdmin=true;
        closeModal(adminPasswordModal);
        openModal(adminModal);
        adminToggleBtn.classList.add('hidden');
      } else adminPwdError.classList.remove('hidden');
    });
    document.getElementById('adminPwdCancel').addEventListener('click',()=>closeModal(adminPasswordModal));

    adminClose.addEventListener('click',()=>closeModal(adminModal));

    function renderAdminList(filter=""){
      adminUmaList.innerHTML="";
      const f = filter.toLowerCase();
      umas.filter(u=>u.name.toLowerCase().includes(f)).forEach(u=>{
        const div = document.createElement('div');
        div.className="flex justify-between items-center p-1 border rounded";
        div.innerHTML=`<span>${u.name}</span><input type="number" min="0" value="${u.score}" class="w-16 p-1 border rounded text-sm">`;
        div.querySelector('input').addEventListener('change',(e)=>{ u.score=parseInt(e.target.value,10)||0; renderSelected(); });
        adminUmaList.appendChild(div);
      });
    }
    adminSearch.addEventListener('input',()=>renderAdminList(adminSearch.value));
    adminSave.addEventListener('click',()=>saveAdminConfig());

    /* ======================
       FIREBASE DATA
       ====================== */
    const teamRefPath = () => ref(db, `teams/${currentTeam}`);
    const configRef = ref(db, 'config');

    function loadData(){
      if(!currentTeam) return;
      onValue(teamRefPath(), snapshot=>{
        const data = snapshot.val();
        if(!data) return;
        selectedUmas = data.selectedUmas || [];
        currentTotal = data.total || 0;
        renderSelected();
      });

      onValue(configRef, snapshot=>{
        const data = snapshot.val();
        if(!data) return;
        if(data.maxScore) maxScore = data.maxScore;
        if(Array.isArray(data.umas)) umas = umas.map(l=>{
          const r = data.umas.find(x=>x.id===l.id);
          return r? {...l,...r}:l;
        });
        renderList(searchInput.value);
        renderAdminList(adminSearch.value);
        renderSelected();
      });
    }

    function saveData(){
      if(!currentTeam) return;
      set(teamRefPath(), { selectedUmas, total:currentTotal }).catch(console.error);
    }

    function saveAdminConfig(){
      if(!isAdmin) return;
      set(configRef,{ maxScore, umas }).catch(console.error);
    }

    /* ======================
       INIT
       ====================== */
    if(currentTeam) applyTeam(currentTeam);
    else openModal(teamModal);

    renderList();
    renderSelected();
    renderAdminList();
</script>
</body>
</html>
