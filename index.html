<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Uma Musume Team Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- HEADER -->
  <header class="bg-pink-600 text-white p-4 flex justify-between items-center shadow">
    <h1 class="text-2xl font-bold">üêé Uma Musume Team Builder</h1>
    <div class="flex gap-3 items-center">
      <span id="teamLabel" class="font-semibold"></span>
      <button id="changeTeamBtn" class="bg-white text-pink-600 px-3 py-1 rounded-lg hover:bg-pink-50 font-medium">
        Changer d‚Äô√©quipe
      </button>
      <button id="adminBtn" class="bg-yellow-400 text-white px-3 py-1 rounded-lg hover:bg-yellow-500 font-medium">
        Mode Admin
      </button>
    </div>
  </header>

  <!-- CONTENU PRINCIPAL -->
  <main id="mainContent" class="flex flex-col md:flex-row flex-1 overflow-hidden hidden">
    <!-- Liste des Uma -->
    <section class="w-full md:w-1/2 p-4 overflow-y-auto border-r border-gray-300">
      <input id="searchInput" type="text" placeholder="üîé Rechercher une Uma..."
             class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring focus:ring-pink-300" />
      <div id="umaList" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
    </section>

    <!-- S√©lection -->
    <section class="w-full md:w-1/2 p-4 overflow-y-auto">
      <h2 class="text-xl font-bold mb-2 text-gray-700">√âquipe s√©lectionn√©e</h2>
      <div id="selectedList" class="space-y-3 mb-4"></div>
      <div class="text-center mt-4">
        <div id="totalScore" class="text-4xl font-extrabold text-pink-600 drop-shadow">0</div>
        <div class="text-lg font-semibold text-gray-600">sur <span id="maxScore">30</span></div>
      </div>
    </section>
  </main>

  <!-- MODALES -->
  <!-- Choix d'√©quipe -->
  <div id="teamModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-80 p-6 text-center">
      <h2 class="text-xl font-bold mb-3 text-pink-600">Connexion d‚Äô√©quipe</h2>
      <select id="teamSelect" class="border rounded p-2 w-full mb-3"></select>
      <input id="teamPasswordInput" type="password" placeholder="Mot de passe" class="border rounded p-2 w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button id="teamCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="teamLogin" class="px-3 py-1 rounded bg-pink-600 text-white hover:bg-pink-700">Se connecter</button>
      </div>
    </div>
  </div>

  <!-- Connexion admin -->
  <div id="adminModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-80 p-6 text-center">
      <h2 class="text-xl font-bold mb-3 text-yellow-600">Connexion Admin</h2>
      <input id="adminPasswordInput" type="password" placeholder="Mot de passe admin"
             class="border rounded p-2 w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button id="adminCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="adminLogin" class="px-3 py-1 rounded bg-yellow-500 text-white hover:bg-yellow-600">Connexion</button>
      </div>
    </div>
  </div>

  <!-- Nom personnalis√© -->
  <div id="nameModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-80 p-6 text-center">
      <h2 class="text-lg font-bold mb-3 text-pink-600">Donnez un nom personnalis√©</h2>
      <input id="customNameInput" type="text" placeholder="Nom" class="border rounded p-2 w-full mb-4" />
      <div class="flex justify-end gap-2">
        <button id="nameCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="nameConfirm" class="px-3 py-1 rounded bg-pink-600 text-white hover:bg-pink-700">Valider</button>
      </div>
    </div>
  </div>

  <!-- Confirmation suppression -->
  <div id="confirmModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-80 p-6 text-center">
      <h2 class="text-lg font-bold mb-3 text-red-600">Supprimer cette Uma ?</h2>
      <div class="flex justify-end gap-2">
        <button id="confirmCancel" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Annuler</button>
        <button id="confirmDelete" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Panneau admin -->
  <div id="adminPanel" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-[90%] md:w-[600px] p-6">
      <h2 class="text-xl font-bold mb-4 text-yellow-600">Panneau d‚Äôadministration</h2>
      <div class="mb-4">
        <label class="font-semibold text-gray-700">Score maximum :</label>
        <input id="adminMaxInput" type="number" min="1"
               class="border rounded p-1 w-24 text-center ml-2" />
      </div>

      <div class="border-t pt-4">
        <h3 class="font-semibold text-gray-700 mb-2">Gestion des √©quipes</h3>
        <div id="adminTeamsList" class="space-y-2 mb-3"></div>
        <div class="flex gap-2 mt-3">
          <input id="newTeamName" type="text" placeholder="Nouvelle √©quipe"
                 class="flex-1 border rounded p-2" />
          <input id="newTeamPwd" type="password" placeholder="Mot de passe"
                 class="flex-1 border rounded p-2" />
          <button id="addTeamBtn"
                  class="bg-pink-600 text-white px-3 py-1 rounded-lg hover:bg-pink-700">Ajouter</button>
        </div>
      </div>

      <div class="flex justify-end mt-6">
        <button id="closeAdminPanel"
                class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg">Fermer</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    // Contiendra les hooks de la Partie 2
    window.__uiHooks = {};

    let umas = [];
    let selectedUmas = [];
    let currentTeam = null;
    let isAdmin = false;
    let currentTotal = 0;
    let maxScore = 30;

    // R√âF√âRENCES DOM
    const mainContent = document.getElementById('mainContent');
    const umaList = document.getElementById('umaList');
    const selectedList = document.getElementById('selectedList');
    const totalScoreElem = document.getElementById('totalScore');
    const maxScoreElem = document.getElementById('maxScore');
    const searchInput = document.getElementById('searchInput');
    const teamLabel = document.getElementById('teamLabel');

    const teamModal = document.getElementById('teamModal');
    const teamSelect = document.getElementById('teamSelect');
    const teamPasswordInput = document.getElementById('teamPasswordInput');

    const adminModal = document.getElementById('adminModal');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const adminPanel = document.getElementById('adminPanel');
    const adminTeamsList = document.getElementById('adminTeamsList');
    const adminMaxInput = document.getElementById('adminMaxInput');

    // Fonction utilitaire d'affichage de modale
    function showModal(el) { el.classList.remove('hidden', 'opacity-0'); el.classList.add('flex'); }
    function hideModal(el) { el.classList.add('hidden'); el.classList.remove('flex'); }

    // RENDU LISTE UMA
    function renderList(filter = '') {
      umaList.innerHTML = '';
      umas.filter(u => u.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach(u => {
          const card = document.createElement('div');
          card.className = "bg-white rounded-xl shadow hover:shadow-lg p-2 flex flex-col items-center cursor-pointer";
          card.innerHTML = `<img src="${u.img}" alt="${u.name}" class="w-20 h-20 object-cover rounded-lg mb-1">
                            <div class="text-center text-sm font-semibold text-gray-700">${u.name}</div>
                            <div class="text-xs text-gray-500">Score: ${u.score}</div>`;
          card.onclick = () => {
            showModal(nameModal);
            nameConfirm.onclick = () => {
              const custom = customNameInput.value.trim();
              if (custom) addUma(u, custom);
              customNameInput.value = '';
              hideModal(nameModal);
            };
            nameCancel.onclick = () => hideModal(nameModal);
          };
          umaList.appendChild(card);
        });
    }

    // AJOUT UMA
    function addUma(uma, customName) {
      const copy = { ...uma, customName };
      selectedUmas.push(copy);
      currentTotal += uma.score;
      renderSelected();
      saveData();
    }

    // SUPPRESSION UMA
    function confirmRemove(index) {
      showModal(confirmModal);
      confirmDelete.onclick = () => {
        const uma = selectedUmas[index];
        currentTotal -= uma.score;
        selectedUmas.splice(index, 1);
        renderSelected();
        saveData();
        hideModal(confirmModal);
      };
      confirmCancel.onclick = () => hideModal(confirmModal);
    }

    // RENDU S√âLECTION
    function renderSelected() {
      selectedList.innerHTML = '';
      selectedUmas.forEach((u, i) => {
        const div = document.createElement('div');
        div.className = "flex items-center bg-white rounded-lg shadow p-2 justify-between";
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${u.img}" class="w-12 h-12 rounded-lg" />
            <div>
              <div class="font-semibold">${u.name}</div>
              <div class="text-sm text-gray-500">${u.customName}</div>
            </div>
          </div>
          <button class="text-red-500 font-bold text-lg hover:text-red-700">√ó</button>
        `;
        div.querySelector('button').onclick = () => confirmRemove(i);
        selectedList.appendChild(div);
      });
      totalScoreElem.textContent = currentTotal;
      totalScoreElem.classList.toggle('text-green-600', currentTotal <= maxScore);
      totalScoreElem.classList.toggle('text-red-600', currentTotal > maxScore);
    }

    searchInput.oninput = e => renderList(e.target.value);

    // Hooks utilis√©s par la Partie 2
    window.__uiHooks.renderSelected = renderSelected;
    window.__uiHooks.renderUmaList = () => renderList(searchInput.value);
    window.__uiHooks.setUmas = u => { umas = u; renderList(searchInput.value); };

    // Boutons connexion
    changeTeamBtn.onclick = () => showModal(teamModal);
    adminBtn.onclick = () => showModal(adminModal);

    // On masque le contenu tant qu‚Äôon n‚Äôest pas connect√©
    mainContent.classList.add('hidden');
  </script>
  <script type="module">
/* --------------------------------------------------------------------------
   PARTIE 2 ‚Äî Gestion Firebase + logique applicative
   -------------------------------------------------------------------------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* ‚öôÔ∏è CONFIG FIREBASE ‚Äî √† personnaliser avec tes propres infos */
const firebaseConfig = {
  apiKey: "AIzaSyCKZBpYvgkTs-273GS9PHV9YIjlX6lIwKI",
  authDomain: "uma-selector-bdc59.firebaseapp.com",
  databaseURL: "https://uma-selector-bdc59-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "uma-selector-bdc59",
  storageBucket: "uma-selector-bdc59.firebasestorage.app",
  messagingSenderId: "204929164113",
  appId: "1:204929164113:web:af408125a77c437a3f2970"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------------------------------------------------------------------------
// R√©f√©rences DOM
// ---------------------------------------------------------------------------
const teamModal = document.getElementById('teamModal');
const teamSelect = document.getElementById('teamSelect');
const teamPasswordInput = document.getElementById('teamPasswordInput');
const teamLogin = document.getElementById('teamLogin');
const teamCancel = document.getElementById('teamCancel');
const adminModal = document.getElementById('adminModal');
const adminPasswordInput = document.getElementById('adminPasswordInput');
const adminLogin = document.getElementById('adminLogin');
const adminCancel = document.getElementById('adminCancel');
const adminPanel = document.getElementById('adminPanel');
const closeAdminPanel = document.getElementById('closeAdminPanel');
const adminTeamsList = document.getElementById('adminTeamsList');
const adminMaxInput = document.getElementById('adminMaxInput');
const addTeamBtn = document.getElementById('addTeamBtn');
const newTeamName = document.getElementById('newTeamName');
const newTeamPwd = document.getElementById('newTeamPwd');

const mainContent = document.getElementById('mainContent');
const teamLabel = document.getElementById('teamLabel');
const totalScoreElem = document.getElementById('totalScore');
const maxScoreElem = document.getElementById('maxScore');

// ---------------------------------------------------------------------------
// Variables d‚Äô√©tat
// ---------------------------------------------------------------------------
let authData = {};     // { "Equipe 1": "toto", "Equipe 2": "toto2", "Admin": "toto3" }
let selectedUmas = [];
let umas = [];
let currentTeam = null;
let isAdmin = false;
let currentTotal = 0;
let maxScore = 30;

// ---------------------------------------------------------------------------
// Chargement initial des donn√©es depuis Firebase
// ---------------------------------------------------------------------------
async function initData() {
  const snapshot = await get(ref(db, '/'));
  if (!snapshot.exists()) {
    await set(ref(db, '/'), {
      auth: { "Equipe 1": "toto", "Equipe 2": "toto2", "Admin": "toto3" },
      teams: { "Equipe 1": { selected: [], total: 0 }, "Equipe 2": { selected: [], total: 0 } },
      settings: { maxScore: 30 },
      umas: []
    });
  }
  listenData();
}

// Synchronisation en temps r√©el
function listenData() {
  onValue(ref(db, '/'), snap => {
    const data = snap.val() || {};
    authData = data.auth || {};
    maxScore = data.settings?.maxScore || 30;
    umas = data.umas || [];

    // Rafra√Æchir interface
    maxScoreElem.textContent = maxScore;
    if (window.__uiHooks?.setUmas) window.__uiHooks.setUmas(umas);
    refreshTeamSelect();
    if (isAdmin) renderAdminPanel();
  });
}

// ---------------------------------------------------------------------------
// Connexion √âQUIPE
// ---------------------------------------------------------------------------
function refreshTeamSelect() {
  teamSelect.innerHTML = '';
  Object.keys(authData).filter(t => t !== "Admin").forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    teamSelect.appendChild(opt);
  });
}

teamLogin.onclick = async () => {
  const team = teamSelect.value;
  const pass = teamPasswordInput.value;
  if (authData[team] && authData[team] === pass) {
    currentTeam = team;
    isAdmin = false;
    localStorage.setItem('uma_team', team);
    hideModal(teamModal);
    showMain();
    loadTeam(team);
  } else {
    alert("Mot de passe incorrect.");
  }
};
teamCancel.onclick = () => hideModal(teamModal);

// ---------------------------------------------------------------------------
// Connexion ADMIN
// ---------------------------------------------------------------------------
adminLogin.onclick = async () => {
  const pass = adminPasswordInput.value;
  if (authData["Admin"] && authData["Admin"] === pass) {
    isAdmin = true;
    currentTeam = "Admin";
    hideModal(adminModal);
    showMain();
    showAdminPanel();
  } else {
    alert("Mot de passe incorrect.");
  }
};
adminCancel.onclick = () => hideModal(adminModal);

// ---------------------------------------------------------------------------
// ADMIN PANEL ‚Äî affichage & modification des √©quipes
// ---------------------------------------------------------------------------
function renderAdminPanel() {
  adminTeamsList.innerHTML = '';
  Object.entries(authData).forEach(([team, pwd]) => {
    if (team === "Admin") return;
    const div = document.createElement('div');
    div.className = "flex items-center gap-2 border p-2 rounded";
    div.innerHTML = `
      <input type="text" value="${team}" class="team-name flex-1 border rounded p-1" />
      <input type="password" value="${pwd}" class="team-pass flex-1 border rounded p-1" />
      <button class="save bg-green-500 text-white px-2 py-1 rounded">üíæ</button>
    `;
    const saveBtn = div.querySelector('.save');
    saveBtn.onclick = async () => {
      const newName = div.querySelector('.team-name').value.trim();
      const newPass = div.querySelector('.team-pass').value.trim();
      if (!newName || !newPass) return;
      // Supprimer l‚Äôancienne cl√© et recr√©er si le nom change
      if (newName !== team) {
        delete authData[team];
        authData[newName] = newPass;
      } else {
        authData[team] = newPass;
      }
      await update(ref(db, '/auth'), authData);
      renderAdminPanel();
      refreshTeamSelect();
    };
    adminTeamsList.appendChild(div);
  });
  adminMaxInput.value = maxScore;
}

addTeamBtn.onclick = async () => {
  const name = newTeamName.value.trim();
  const pass = newTeamPwd.value.trim();
  if (!name || !pass) return;
  authData[name] = pass;
  await update(ref(db, '/auth'), authData);
  newTeamName.value = '';
  newTeamPwd.value = '';
  renderAdminPanel();
  refreshTeamSelect();
};

adminMaxInput.onchange = async () => {
  const newMax = parseInt(adminMaxInput.value);
  if (!isNaN(newMax)) {
    maxScore = newMax;
    await update(ref(db, '/settings'), { maxScore: newMax });
  }
};

function showAdminPanel() { showModal(adminPanel); renderAdminPanel(); }
closeAdminPanel.onclick = () => hideModal(adminPanel);

// ---------------------------------------------------------------------------
// Sauvegarde s√©lection √©quipe
// ---------------------------------------------------------------------------
async function saveData() {
  if (!currentTeam || isAdmin) return;
  await update(ref(db, `/teams/${currentTeam}`), {
    selected: selectedUmas,
    total: currentTotal
  });
}

// Chargement des donn√©es d‚Äô√©quipe
async function loadTeam(team) {
  const snap = await get(ref(db, `/teams/${team}`));
  if (snap.exists()) {
    const data = snap.val();
    selectedUmas = data.selected || [];
    currentTotal = data.total || 0;
    if (window.__uiHooks?.renderSelected) window.__uiHooks.renderSelected();
  } else {
    selectedUmas = [];
    currentTotal = 0;
  }
}

// ---------------------------------------------------------------------------
// Helpers interface
// ---------------------------------------------------------------------------
function showMain() {
  teamLabel.textContent = isAdmin ? "Admin" : `√âquipe : ${currentTeam}`;
  mainContent.classList.remove('hidden');
  if (!isAdmin) loadTeam(currentTeam);
}

function showModal(el) { el.classList.remove('hidden', 'opacity-0'); el.classList.add('flex'); }
function hideModal(el) { el.classList.add('hidden'); el.classList.remove('flex'); }

// ---------------------------------------------------------------------------
// Auto-connexion si d√©j√† stock√©e
// ---------------------------------------------------------------------------
initData().then(() => {
  const saved = localStorage.getItem('uma_team');
  if (saved && saved !== "Admin" && authData[saved]) {
    currentTeam = saved;
    showMain();
    loadTeam(saved);
  } else {
    showModal(teamModal);
  }
});
</script>
