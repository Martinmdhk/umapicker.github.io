<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Uma Musume Team Selector</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  /* üíñ Style Uma Musume Pastel */
  body {
    background: linear-gradient(180deg, #fff5fa 0%, #f9e3ff 100%);
    font-family: "Nunito", sans-serif;
  }

  header {
    background: linear-gradient(90deg, #ff77b7, #f78aff);
  }

  /* Cartes Uma */
  #umaList > div, #selectedUmas > div {
    transition: all 0.2s ease;
    border: 2px solid transparent;
    background: white;
  }
  #umaList > div:hover, #selectedUmas > div:hover {
    transform: translateY(-3px);
    border-color: #fca5a5;
    box-shadow: 0 6px 10px rgba(255, 105, 180, 0.2);
  }

  /* Modales */
  #teamModal > div, #adminModal > div, #nameModal > div, #deleteModal > div {
    animation: fadeIn 0.25s ease;
  }

  @keyframes fadeIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Boutons ronds */
  button {
    transition: all 0.15s ease;
  }
  button:hover {
    transform: scale(1.05);
  }

  /* Scrollbar personnalis√©e */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: rgba(255, 182, 193, 0.8);
    border-radius: 8px;
  }

  /* Admin Panel style */
  #adminPanel {
    background: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(6px);
  }
</style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Barre sup√©rieure -->
  <header class="flex justify-between items-center bg-pink-500 text-white p-4 shadow">
    <div class="text-xl font-bold">üêé Uma Musume Team Builder</div>
    <div class="flex items-center gap-4">
      <div id="teamDisplay" class="font-semibold">Aucune √©quipe</div>
      <button id="changeTeamBtn" class="bg-white text-pink-600 px-3 py-1 rounded-lg hover:bg-pink-100">Changer d‚Äô√©quipe</button>
      <button id="adminBtn" class="bg-yellow-400 text-gray-900 px-3 py-1 rounded-lg hover:bg-yellow-300">Mode Admin</button>
    </div>
  </header>

  <!-- Conteneur principal -->
  <main id="mainContainer" class="hidden flex flex-row h-[calc(100vh-64px)]">
    <!-- Liste gauche -->
    <section id="leftPanel" class="w-1/2 p-4 border-r border-gray-300 overflow-y-auto">
      <input id="searchInput" type="text" placeholder="Rechercher une Uma..."
             class="w-full mb-4 p-2 border rounded-lg focus:ring-2 focus:ring-pink-400 outline-none"/>

      <div id="umaList" class="grid grid-cols-2 gap-4"></div>
    </section>

    <!-- S√©lection droite -->
    <section id="rightPanel" class="w-1/2 p-4 overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4 text-center">√âquipe s√©lectionn√©e</h2>
      <div id="totalScoreDisplay" class="text-center mb-4">
        <span id="currentTotal" class="text-5xl font-bold text-green-600">0</span>
        <span class="text-3xl text-gray-600"> / </span>
        <span id="maxScore" class="text-3xl text-gray-600">30</span>
      </div>
      <div id="selectedUmas" class="grid grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- Modal de s√©lection d‚Äô√©quipe -->
  <div id="teamModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Choisir une √©quipe</h2>
      <select id="teamSelect" class="w-full border rounded p-2 mb-3"></select>
      <input id="teamPassword" type="password" placeholder="Mot de passe de l‚Äô√©quipe"
             class="w-full border rounded p-2 mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="cancelTeam" class="px-3 py-1 bg-gray-300 rounded">Annuler</button>
        <button id="confirmTeam" class="px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600">Connexion</button>
      </div>
    </div>
  </div>

  <!-- Modal Admin (connexion) -->
  <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Connexion administrateur</h2>
      <input id="adminPassword" type="password" placeholder="Mot de passe admin"
             class="w-full border rounded p-2 mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="cancelAdmin" class="px-3 py-1 bg-gray-300 rounded">Annuler</button>
        <button id="confirmAdmin" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Connexion</button>
      </div>
    </div>
  </div>

  <!-- Modal Nom personnalis√© -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-96">
      <h2 class="text-lg font-bold mb-3">Nom personnalis√© pour cette Uma</h2>
      <input id="customNameInput" type="text" placeholder="Entrez un nom"
             class="w-full border rounded p-2 mb-4"/>
      <div class="flex justify-end gap-2">
        <button id="cancelName" class="px-3 py-1 bg-gray-300 rounded">Annuler</button>
        <button id="confirmName" class="px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600">Valider</button>
      </div>
    </div>
  </div>

  <!-- Modal confirmation suppression -->
  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-96 text-center">
      <h2 class="text-lg font-bold mb-4">Supprimer cette Uma ?</h2>
      <div class="flex justify-center gap-4">
        <button id="cancelDelete" class="px-3 py-1 bg-gray-300 rounded">Annuler</button>
        <button id="confirmDelete" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Zone Admin -->
  <div id="adminPanel" class="hidden fixed inset-0 bg-white bg-opacity-95 overflow-y-auto z-40 p-6">
    <h2 class="text-2xl font-bold text-center mb-6">Panneau Administrateur</h2>
    <div class="flex justify-center mb-6">
      <label class="font-semibold mr-2">Score maximum :</label>
      <input id="adminMax" type="number" min="1" class="border p-2 rounded w-24 text-center"/>
      <button id="saveMax" class="ml-2 bg-pink-500 text-white px-3 py-1 rounded">üíæ</button>
    </div>
    <div id="adminUmaList" class="grid grid-cols-2 gap-4 mb-10"></div>

    <div class="border-t pt-6">
      <h3 class="text-lg font-bold mb-2">Gestion des √©quipes</h3>
      <div id="teamListAdmin" class="space-y-2 mb-6"></div>
      <div class="mt-4 flex gap-2 items-center">
        <input id="newTeamName" placeholder="Nom de l'√©quipe" class="border p-1 rounded flex-1"/>
        <input id="newTeamPwd" type="password" placeholder="Mot de passe" class="border p-1 rounded flex-1"/>
        <button id="addTeamBtn" class="bg-green-500 text-white px-3 py-1 rounded">‚ûï</button>
      </div>
    </div>
    <div class="text-center mt-8">
      <button id="closeAdmin" class="bg-gray-400 text-white px-4 py-2 rounded">Fermer</button>
    </div>
  </div>

  <!-- Script principal (logique d'interface, sans Firebase) -->
  <script type="module">
    window.__uiHooks = {};
    let umas = [];
    let selectedUmas = [];
    let currentTotal = 0;
    let maxScore = 30;
    let currentTeam = null;
    let isAdmin = false;
    let umaToDelete = null;

    // ============ Fonctions UI ============

    const umaList = document.getElementById('umaList');
    const selectedList = document.getElementById('selectedUmas');
    const totalEl = document.getElementById('currentTotal');
    const maxEl = document.getElementById('maxScore');

    function renderUmaList(filter = '') {
      umaList.innerHTML = '';
      const filtered = umas.filter(u => u.name.toLowerCase().includes(filter.toLowerCase()));
      for (const u of filtered) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow hover:shadow-md p-2 flex flex-col items-center cursor-pointer';
        card.innerHTML = `
          <img src="${u.img}" alt="${u.name}" class="w-24 h-24 object-cover rounded-full mb-2">
          <div class="font-bold text-center">${u.name}</div>
          <div class="text-sm text-gray-600">Score: ${u.score}</div>
        `;
        card.onclick = () => {
          document.getElementById('nameModal').classList.remove('hidden');
          document.getElementById('confirmName').onclick = () => {
            const custom = document.getElementById('customNameInput').value.trim();
            if (!custom) return;
            selectedUmas.push({ ...u, custom });
            currentTotal = selectedUmas.reduce((s,x)=>s+(x.score||0),0);
            renderSelected();
            document.getElementById('nameModal').classList.add('hidden');
            document.getElementById('customNameInput').value = '';
            saveData();
          };
        };
        umaList.appendChild(card);
      }
    }
    window.__uiHooks.renderUmaList = renderUmaList;
    window.__uiHooks.setUmas = list => { umas = list; renderUmaList(); };

    function renderSelected() {
      selectedList.innerHTML = '';
      totalEl.textContent = currentTotal;
      maxEl.textContent = maxScore;
      totalEl.className = 'text-5xl font-bold ' + (currentTotal>maxScore ? 'text-red-600' : 'text-green-600');
      for (const u of selectedUmas) {
        const div = document.createElement('div');
        div.className = 'bg-white p-3 rounded-lg shadow relative';
        div.innerHTML = `
          <img src="${u.img}" alt="${u.name}" class="w-full h-32 object-cover rounded mb-2">
          <div class="font-bold text-center">${u.name}</div>
          <div class="text-sm text-gray-500 text-center">(${u.custom})</div>
          <div class="absolute top-1 right-2 text-red-500 cursor-pointer text-xl">√ó</div>
        `;
        div.querySelector('div.absolute').onclick = () => {
          umaToDelete = u;
          document.getElementById('deleteModal').classList.remove('hidden');
        };
        selectedList.appendChild(div);
      }
    }
    window.__uiHooks.renderSelected = renderSelected;

    document.getElementById('confirmDelete').onclick = () => {
      selectedUmas = selectedUmas.filter(x => x !== umaToDelete);
      currentTotal = selectedUmas.reduce((s,x)=>s+(x.score||0),0);
      renderSelected();
      document.getElementById('deleteModal').classList.add('hidden');
      saveData();
    };
    document.getElementById('cancelDelete').onclick = () => document.getElementById('deleteModal').classList.add('hidden');

    // Recherche
    document.getElementById('searchInput').oninput = e => renderUmaList(e.target.value);

    // Connexion √©quipe
    document.getElementById('changeTeamBtn').onclick = () => document.getElementById('teamModal').classList.remove('hidden');
    document.getElementById('cancelTeam').onclick = () => document.getElementById('teamModal').classList.add('hidden');
    document.getElementById('confirmTeam').onclick = async () => {
      const team = document.getElementById('teamSelect').value;
      const pwd = document.getElementById('teamPassword').value;
      if (!team || !pwd) return;
      const ok = await window.__authClientValidate(team, pwd);
      if (ok) {
        currentTeam = team;
        isAdmin = false;
        localStorage.setItem('umaSession', JSON.stringify({ team, isAdmin: false }));
        document.getElementById('teamDisplay').textContent = '√âquipe : ' + team;
        document.getElementById('teamModal').classList.add('hidden');
        document.getElementById('mainContainer').classList.remove('hidden');
        window.__loadRemoteForTeam(team);
      } else alert('Mot de passe incorrect');
    };

    // Connexion admin
    document.getElementById('adminBtn').onclick = () => document.getElementById('adminModal').classList.remove('hidden');
    document.getElementById('cancelAdmin').onclick = () => document.getElementById('adminModal').classList.add('hidden');
    document.getElementById('confirmAdmin').onclick = async () => {
      const pwd = document.getElementById('adminPassword').value;
      const res = await window.__adminValidate(pwd);
      if (res.ok) {
        isAdmin = true;
        currentTeam = res.team;
        localStorage.setItem('umaSession', JSON.stringify({ team: res.team, isAdmin: true }));
        document.getElementById('adminModal').classList.add('hidden');
        document.getElementById('teamDisplay').textContent = 'ADMIN';
        document.getElementById('mainContainer').classList.remove('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        window.__loadRemoteForTeam(res.team);
        renderAdminTeams();
      } else alert('Mot de passe admin incorrect');
    };

    // Admin UI
    document.getElementById('saveMax').onclick = () => {
      const val = parseInt(document.getElementById('adminMax').value);
      if (!isNaN(val) && val > 0) {
        maxScore = val;
        saveAdminConfig();
        renderSelected();
      }
    };
    document.getElementById('closeAdmin').onclick = () => document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('addTeamBtn').onclick = () => {
      const name = document.getElementById('newTeamName').value.trim();
      const pwd = document.getElementById('newTeamPwd').value.trim();
      if (name && pwd) window.__addTeam(name, pwd);
    };

    // Rendu admin teams (sera rempli via Firebase)
    function renderAdminTeams() {
      const container = document.getElementById('teamListAdmin');
      container.innerHTML = '';
      const list = window.teamsList || [];
      for (const t of list) {
        const row = document.createElement('div');
        row.className = 'flex gap-2 items-center bg-gray-100 p-2 rounded';
        row.innerHTML = `
          <input type="text" class="flex-1 p-1 rounded border nameInput" value="${t}">
          <input type="password" class="p-1 rounded border pwdInput" placeholder="Nouveau mot de passe">
          <button class="bg-green-500 text-white px-2 py-1 rounded editBtn">üíæ</button>
          <button class="bg-red-500 text-white px-2 py-1 rounded deleteBtn">üóë</button>
        `;
        row.querySelector('.editBtn').onclick = () => {
          const newName = row.querySelector('.nameInput').value.trim();
          const newPwd = row.querySelector('.pwdInput').value.trim();
          window.__editTeam(t, newName, newPwd);
        };
        row.querySelector('.deleteBtn').onclick = () => {
          if (confirm(`Supprimer ${t} ?`)) window.__deleteTeam(t);
        };
        container.appendChild(row);
      }
    }
    window.__uiHooks.renderAdminTeams = renderAdminTeams;
  </script>
   <!-- Firebase et logique de donn√©es -->
  <script type="module">
    // ============================================
    // üî• Initialisation Firebase
    // ============================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, set, get, onValue, update, remove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKZBpYvgkTs-273GS9PHV9YIjlX6lIwKI",
      authDomain: "uma-selector-bdc59.firebaseapp.com",
      databaseURL: "https://uma-selector-bdc59-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "uma-selector-bdc59",
      storageBucket: "uma-selector-bdc59.firebasestorage.app",
      messagingSenderId: "204929164113",
      appId: "1:204929164113:web:af408125a77c437a3f2970"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ============================================
    // üß© Authentification d‚Äô√©quipe et admin
    // ============================================
    window.teamsList = [];

    // R√©cup√®re la liste des √©quipes et mots de passe
    async function fetchTeams() {
      const snapshot = await get(ref(db, "auth"));
      if (snapshot.exists()) {
        const data = snapshot.val();
        window.authData = data;
        window.teamsList = Object.keys(data).filter(k => k !== "Admin");
        const select = document.getElementById("teamSelect");
        select.innerHTML = "";
        for (const team of window.teamsList) {
          const opt = document.createElement("option");
          opt.value = team;
          opt.textContent = team;
          select.appendChild(opt);
        }
        if (window.__uiHooks.renderAdminTeams) window.__uiHooks.renderAdminTeams();
      }
    }

    fetchTeams();

    window.__authClientValidate = async (team, pwd) => {
      const snap = await get(ref(db, `auth/${team}`));
      return snap.exists() && snap.val() === pwd;
    };

    window.__adminValidate = async (pwd) => {
      const snap = await get(ref(db, "auth/Admin"));
      if (snap.exists() && snap.val() === pwd) return { ok: true, team: "Admin" };
      return { ok: false };
    };

    // ============================================
    // üíæ Gestion donn√©es d‚Äô√©quipe
    // ============================================
    window.__loadRemoteForTeam = (team) => {
      if (!team) return;
      onValue(ref(db, `teams/${team}`), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        selectedUmas = data.selectedUmas || [];
        currentTotal = selectedUmas.reduce((s, x) => s + (x.score || 0), 0);
        maxScore = data.maxScore || 30;
        window.__uiHooks.renderSelected();
      });
    };

    function saveData() {
      if (!currentTeam) return;
      set(ref(db, `teams/${currentTeam}/selectedUmas`), selectedUmas);
    }

    function saveAdminConfig() {
      if (!currentTeam) return;
      update(ref(db, `teams/${currentTeam}`), { maxScore });
    }

    window.saveData = saveData;
    window.saveAdminConfig = saveAdminConfig;

    // ============================================
    // üß† Gestion Admin : modification des √©quipes
    // ============================================
    window.__addTeam = async (name, pwd) => {
      await set(ref(db, `auth/${name}`), pwd);
      await set(ref(db, `teams/${name}`), { maxScore: 30, selectedUmas: [] });
      fetchTeams();
      document.getElementById("newTeamName").value = "";
      document.getElementById("newTeamPwd").value = "";
      alert("√âquipe ajout√©e !");
    };

    window.__editTeam = async (oldName, newName, newPwd) => {
      const data = await get(ref(db, `auth/${oldName}`));
      if (!data.exists()) return alert("√âquipe introuvable !");
      const pwdToSave = newPwd || data.val();

      if (oldName !== newName) {
        const teamData = await get(ref(db, `teams/${oldName}`));
        await set(ref(db, `auth/${newName}`), pwdToSave);
        await set(ref(db, `teams/${newName}`), teamData.val());
        await remove(ref(db, `auth/${oldName}`));
        await remove(ref(db, `teams/${oldName}`));
      } else {
        await set(ref(db, `auth/${newName}`), pwdToSave);
      }

      fetchTeams();
      alert("√âquipe modifi√©e !");
    };

    window.__deleteTeam = async (team) => {
      await remove(ref(db, `auth/${team}`));
      await remove(ref(db, `teams/${team}`));
      fetchTeams();
      alert("√âquipe supprim√©e !");
    };

    // ============================================
    // üêé Chargement des Uma Musume
    // ============================================
    async function loadUmas() {
      const res = await fetch("https://gametora.com/api/umamusume/characters");
      const data = await res.json();
      const list = data.map(u => ({
        name: u.name,
        img: u.icon,
        score: Math.floor(Math.random() * 5) + 1
      }));
      window.__uiHooks.setUmas(list);
    }

    loadUmas();

    // ============================================
    // üß† Persistance locale
    // ============================================
    const session = JSON.parse(localStorage.getItem("umaSession") || "{}");
    if (session.team) {
      currentTeam = session.team;
      isAdmin = session.isAdmin;
      document.getElementById("teamDisplay").textContent = isAdmin ? "ADMIN" : "√âquipe : " + currentTeam;
      document.getElementById("mainContainer").classList.remove("hidden");
      window.__loadRemoteForTeam(currentTeam);
      if (isAdmin) document.getElementById("adminPanel").classList.remove("hidden");
    }

  </script>
</body>
</html>
